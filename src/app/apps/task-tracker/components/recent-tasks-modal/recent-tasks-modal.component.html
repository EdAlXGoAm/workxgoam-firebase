<!-- Modal para tareas recientes -->
<div *ngIf="visible && recentTasks.length > 0"
     class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4"
     (click)="onClose()"
     style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col"
       (click)="$event.stopPropagation()"
       style="overflow-y: auto;">
    <!-- Header del modal -->
    <div class="p-4 md:p-6 border-b border-gray-200 flex-shrink-0 bg-indigo-50">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold text-indigo-900 flex items-center">
          <i class="fas fa-history mr-2"></i>
          Tareas Recientes
        </h3>
        <button (click)="onClose()" class="text-gray-500 hover:text-gray-700 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <p class="text-xs text-indigo-700 mt-2">
        <i class="fas fa-info-circle mr-1"></i>
        Selecciona una tarea para copiar autom√°ticamente: nombre, tipo, emoji, descripci√≥n, prioridad y duraci√≥n
      </p>
    </div>

    <!-- Contenido scrollable -->
    <div class="flex-1 overflow-y-auto p-4 md:p-6">
      <!-- Grupos de tareas (tareas con nombre repetido) -->
      <div *ngIf="multipleTaskGroups.length > 0" class="mb-4">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2">
          <i class="fas fa-layer-group"></i>
          Tareas agrupadas ({{ multipleTaskGroups.length }})
        </div>
        <div class="space-y-2">
          <div *ngFor="let group of multipleTaskGroups; trackBy: trackByGroupName" class="border border-gray-200 rounded-lg overflow-hidden">
            <!-- Header del grupo (clickeable para expandir/colapsar, click derecho para men√∫) -->
            <div (click)="onToggleGroup(group.name)"
                 (contextmenu)="onGroupContextMenu($event, group.name)"
                 (touchstart)="onGroupTouchStart($event, group.name)"
                 (touchend)="groupTouchEnd.emit()"
                 (touchmove)="groupTouchMove.emit()"
                 class="recent-tasks-clickable p-3 bg-gray-50 hover:bg-gray-100 cursor-pointer flex items-center gap-3 transition-colors">
              <span class="text-2xl flex-shrink-0">{{ group.emoji }}</span>
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-gray-900 truncate">{{ group.name }}</h4>
                <span class="text-xs text-gray-500">{{ group.tasks.length }} tareas</span>
              </div>
              <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"
                 [class.rotate-180]="isGroupExpanded(group.name)"></i>
            </div>

            <!-- Tareas del grupo (expandibles) -->
            <div *ngIf="isGroupExpanded(group.name)" class="border-t border-gray-200 bg-white">
              <div *ngFor="let item of group.tasks; let isLast = last; trackBy: trackByOriginalIndex"
                   (click)="editingTaskIndex !== item.originalIndex && onApplyTask(item.originalIndex); $event.stopPropagation()"
                   (contextmenu)="onRecentTaskContextMenu($event, item.originalIndex)"
                   (touchstart)="onRecentTaskTouchStart($event, item.originalIndex)"
                   (touchend)="recentTaskTouchEnd.emit()"
                   (touchmove)="recentTaskTouchMove.emit()"
                   class="recent-tasks-clickable p-3 pl-6 hover:bg-indigo-50 cursor-pointer transition-colors"
                   [class.border-b]="!isLast"
                   [class.border-gray-100]="!isLast"
                   [class.ring-2]="editingTaskIndex === item.originalIndex"
                   [class.ring-indigo-500]="editingTaskIndex === item.originalIndex"
                   [class.ring-inset]="editingTaskIndex === item.originalIndex">
                <div class="flex items-start gap-3">
                  <!-- Emoji - editable -->
                  <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'emoji'; else groupNormalEmoji">
                    <button type="button"
                            (click)="setShowEmojiPickerForEdit(true); $event.stopPropagation()"
                            class="text-xl flex-shrink-0 p-1 rounded hover:bg-indigo-100 border-2 border-indigo-400">
                      {{ editingValue || 'üìù' }}
                    </button>
                  </ng-container>
                  <ng-template #groupNormalEmoji>
                    <span class="text-xl flex-shrink-0 opacity-50">{{ item.task.emoji || 'üìù' }}</span>
                  </ng-template>

                  <div class="flex-1 min-w-0">
                    <!-- Nombre - editable -->
                    <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'name'; else groupNormalName">
                      <div class="flex items-center gap-2">
                        <input type="text"
                               id="edit-task-name-input"
                               [ngModel]="editingValue"
                               (ngModelChange)="editingValueChange.emit($event)"
                               (keydown)="onEditNameKeydown($event)"
                               (blur)="saveQuickEdit.emit()"
                               (click)="$event.stopPropagation()"
                               class="flex-1 px-2 py-1 text-sm border border-indigo-400 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Nombre de la tarea">
                        <button type="button"
                                (click)="saveQuickEdit.emit(); $event.stopPropagation()"
                                class="p-1 text-green-600 hover:bg-green-100 rounded"
                                [disabled]="isSavingQuickEdit">
                          <i class="fas fa-check"></i>
                        </button>
                        <button type="button"
                                (click)="cancelQuickEdit.emit(); $event.stopPropagation()"
                                class="p-1 text-gray-500 hover:bg-gray-100 rounded">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </ng-container>
                    <ng-template #groupNormalName>
                      <!-- Mostrar solo la fecha como t√≠tulo ya que el nombre es el del grupo -->
                      <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-600">
                        <span *ngIf="item.task.start" class="flex items-center">
                          <i class="fas fa-play text-green-500 mr-1"></i>
                          {{ formatRecentTaskDate(item.task.start) }}
                        </span>
                        <span *ngIf="item.task.end" class="flex items-center">
                          <i class="fas fa-stop text-red-500 mr-1"></i>
                          {{ formatRecentTaskDate(item.task.end) }}
                        </span>
                        <span *ngIf="item.task.duration" class="flex items-center font-medium text-indigo-600">
                          <i class="fas fa-clock mr-1"></i>
                          {{ formatDuration(item.task.duration) }}
                        </span>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tareas unitarias (nombre √∫nico) -->
      <div *ngIf="singleTasks.length > 0">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2">
          <i class="fas fa-tasks"></i>
          Tareas individuales ({{ singleTasks.length }})
        </div>
        <div class="space-y-2">
          <div *ngFor="let item of singleTasks; trackBy: trackByOriginalIndex"
               (click)="editingTaskIndex !== item.originalIndex && onApplyTask(item.originalIndex)"
               (contextmenu)="onRecentTaskContextMenu($event, item.originalIndex)"
               (touchstart)="onRecentTaskTouchStart($event, item.originalIndex)"
               (touchend)="recentTaskTouchEnd.emit()"
               (touchmove)="recentTaskTouchMove.emit()"
               class="recent-tasks-clickable p-3 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-colors"
               [class.ring-2]="editingTaskIndex === item.originalIndex"
               [class.ring-indigo-500]="editingTaskIndex === item.originalIndex">
            <div class="flex items-start gap-3">
              <!-- Emoji - editable -->
              <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'emoji'; else singleNormalEmoji">
                <button type="button"
                        (click)="setShowEmojiPickerForEdit(true); $event.stopPropagation()"
                        class="text-2xl flex-shrink-0 p-1 rounded hover:bg-indigo-100 border-2 border-indigo-400">
                  {{ editingValue || 'üìù' }}
                </button>
              </ng-container>
              <ng-template #singleNormalEmoji>
                <span class="text-2xl flex-shrink-0">{{ item.task.emoji || 'üìù' }}</span>
              </ng-template>

              <div class="flex-1 min-w-0">
                <!-- Nombre - editable -->
                <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'name'; else singleNormalName">
                  <div class="flex items-center gap-2">
                    <input type="text"
                           id="edit-task-name-input"
                           [ngModel]="editingValue"
                           (ngModelChange)="editingValueChange.emit($event)"
                           (keydown)="onEditNameKeydown($event)"
                           (blur)="saveQuickEdit.emit()"
                           (click)="$event.stopPropagation()"
                           class="flex-1 px-2 py-1 text-sm border border-indigo-400 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Nombre de la tarea">
                    <button type="button"
                            (click)="saveQuickEdit.emit(); $event.stopPropagation()"
                            class="p-1 text-green-600 hover:bg-green-100 rounded"
                            [disabled]="isSavingQuickEdit">
                      <i class="fas fa-check"></i>
                    </button>
                    <button type="button"
                            (click)="cancelQuickEdit.emit(); $event.stopPropagation()"
                            class="p-1 text-gray-500 hover:bg-gray-100 rounded">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </ng-container>
                <ng-template #singleNormalName>
                  <h4 class="font-medium text-gray-900 truncate">{{ item.task.name }}</h4>
                </ng-template>

                <!-- Fechas de inicio y fin -->
                <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-500 mt-1">
                  <span *ngIf="item.task.start" class="flex items-center">
                    <i class="fas fa-play text-green-500 mr-1"></i>
                    {{ formatRecentTaskDate(item.task.start) }}
                  </span>
                  <span *ngIf="item.task.end" class="flex items-center">
                    <i class="fas fa-stop text-red-500 mr-1"></i>
                    {{ formatRecentTaskDate(item.task.end) }}
                  </span>
                  <span *ngIf="item.task.duration" class="flex items-center font-medium text-indigo-600">
                    <i class="fas fa-clock mr-1"></i>
                    {{ formatDuration(item.task.duration) }}
                  </span>
                </div>
                <div *ngIf="item.task.description" class="text-xs text-gray-600 mt-1 line-clamp-2">
                  {{ item.task.description }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje cuando no hay tareas -->
      <div *ngIf="recentTasks.length === 0" class="text-center text-gray-500 py-8">
        <i class="fas fa-inbox text-3xl mb-2 text-gray-300"></i>
        <p>No hay tareas recientes en este proyecto</p>
      </div>
    </div>
  </div>
</div>
