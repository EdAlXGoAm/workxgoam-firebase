<div #containerRef class="week-timeline-container w-full overflow-auto relative">
  <!-- Toggle de modo de coloreado (solo visible cuando hay ambiente enfocado) -->
  <div *ngIf="focusedEnvironmentId" class="color-mode-toggle mb-3 flex items-center justify-center gap-2 bg-white rounded-lg p-2 shadow-sm border">
    <button 
      (click)="toggleColorMode()"
      class="toggle-button flex items-center gap-2 px-4 py-2 rounded-md transition-all duration-200"
      [class.active-environment]="colorMode === 'environment'"
      [class.active-tasktype]="colorMode === 'taskType'"
      title="Cambiar modo de coloreado">
      <i class="fas" [class.fa-layer-group]="colorMode === 'environment'" [class.fa-tag]="colorMode === 'taskType'"></i>
      <span class="text-sm font-medium">
        {{ colorMode === 'environment' ? 'Color por Ambiente' : 'Color por Tipo de Tarea' }}
      </span>
    </button>
  </div>
  
  <!-- Controles de Zoom y Filtros -->
  <div class="controls-row mb-3 flex flex-col sm:flex-row items-center justify-center gap-3">
    <!-- Controles de Zoom -->
    <div class="zoom-controls flex items-center justify-center gap-2 bg-white rounded-lg p-2 shadow-sm border">
      <button 
        (click)="zoomOut()"
        [disabled]="!canZoomOut()"
        class="zoom-btn flex items-center justify-center w-8 h-8 rounded-md bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        title="Alejar (Zoom Out)">
        <i class="fas fa-search-minus text-sm text-gray-600"></i>
      </button>
      <span class="text-sm font-medium text-gray-700 px-2 min-w-[60px] text-center">
        {{ (zoomScale * 100).toFixed(0) }}%
      </span>
      <button 
        (click)="zoomIn()"
        [disabled]="!canZoomIn()"
        class="zoom-btn flex items-center justify-center w-8 h-8 rounded-md bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        title="Acercar (Zoom In)">
        <i class="fas fa-search-plus text-sm text-gray-600"></i>
      </button>
      <button 
        (click)="resetZoom()"
        [disabled]="isZoomReset()"
        class="zoom-btn flex items-center justify-center w-8 h-8 rounded-md bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        title="Restablecer zoom">
        <i class="fas fa-search text-sm text-gray-600"></i>
      </button>
    </div>

    <!-- Switch de D칤as Laborales -->
    <div class="weekend-toggle flex items-center justify-center gap-2 bg-white rounded-lg p-2 shadow-sm border">
      <label class="flex items-center gap-2 cursor-pointer">
        <span class="text-sm font-medium text-gray-700">Solo d칤as laborales</span>
        <div class="relative inline-block w-12 h-6">
          <input 
            type="checkbox" 
            [checked]="!showWeekends"
            (change)="toggleWeekends()"
            class="sr-only peer">
          <div class="w-12 h-6 bg-gray-300 rounded-full peer peer-checked:bg-indigo-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 transition-colors">
            <div class="absolute top-[2px] left-[2px] bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform peer-checked:translate-x-6"></div>
          </div>
        </div>
      </label>
    </div>
  </div>

  <!-- Controles de Navegaci칩n de Semana -->
  <div class="week-navigation mb-4 flex flex-col md:flex-row items-center justify-between bg-white rounded-lg p-3 shadow-sm border gap-3">
    <!-- Primera fila: Navegador de semanas -->
    <div class="flex items-center space-x-2 w-full md:w-auto justify-center md:justify-start">
      <button (click)="goToPreviousWeek()" 
              class="nav-btn flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
              title="Semana anterior">
        <i class="fas fa-chevron-left text-sm text-gray-600"></i>
      </button>
      
      <div class="week-display text-sm font-semibold text-gray-700 px-2 text-center">
        {{ formatWeekRange() }}
      </div>
      
      <button (click)="goToNextWeek()" 
              class="nav-btn flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
              title="Semana siguiente">
        <i class="fas fa-chevron-right text-sm text-gray-600"></i>
      </button>
    </div>
    
    <!-- Segunda fila: Selector y bot칩n Esta Semana -->
    <div class="flex items-center space-x-3 w-full md:w-auto justify-center md:justify-end">
      <div class="w-48 flex-shrink-0">
        <app-android-date-picker
          [ngModel]="getWeekInputValue()"
          (dateChange)="onWeekDateChange($event)"
          label="Seleccionar semana"
          placeholder="Seleccionar semana"
          class="date-picker">
        </app-android-date-picker>
      </div>
      
      <button (click)="goToCurrentWeek()" 
              [class.bg-indigo-100]="isCurrentWeek()"
              [class.text-indigo-700]="isCurrentWeek()"
              [class.bg-gray-100]="!isCurrentWeek()"
              [class.text-gray-700]="!isCurrentWeek()"
              class="nav-btn px-3 py-1 rounded-md text-sm font-medium hover:bg-indigo-50 transition-colors flex-shrink-0"
              title="Ir a esta semana">
        Esta Semana
      </button>
    </div>
  </div>

  <!-- Tooltip para mostrar informaci칩n completa de la tarea -->
  <div *ngIf="showTooltip && tooltipTask" 
       class="tooltip-container absolute top-[150px] left-1/2 transform -translate-x-1/2 z-50 bg-gray-900 text-white px-6 py-5 rounded-xl shadow-2xl max-w-2xl min-w-[400px]">
    <div class="flex items-start space-x-4">
      <span class="text-3xl flex-shrink-0">{{ tooltipTask.emoji }}</span>
      <div *ngIf="getTaskTypeColor(tooltipTask)" 
           class="w-5 h-5 rounded-full border-2 border-white shadow-sm flex-shrink-0 mt-1" 
           [style.background-color]="getTaskTypeColor(tooltipTask)"></div>
      <div class="flex-1">
        <div class="font-bold text-lg mb-2">{{ getTaskDisplayName(tooltipTask) }}</div>
        <div *ngIf="tooltipTask.description" class="text-sm text-gray-200 mt-2 mb-3 leading-relaxed">{{ tooltipTask.description }}</div>
        <div class="flex flex-wrap gap-4 mt-3">
          <div class="text-sm text-gray-300 flex items-center space-x-2">
            <i class="fas fa-clock text-xs"></i>
            <span>{{ formatTaskTime(tooltipTask.start) }} - {{ formatTaskTime(tooltipTask.end) }}</span>
          </div>
          <div *ngIf="getTaskDuration(tooltipTask)" class="text-sm text-purple-300 flex items-center space-x-2">
            <i class="fas fa-hourglass-half text-xs"></i>
            <span>Duraci칩n: {{ formatTaskDuration(getTaskDuration(tooltipTask)) }}</span>
          </div>
        </div>
        <!-- Info de tarea compleja -->
        <div *ngIf="taskHasComplexGroup(tooltipTask) && getComplexGroupTotalDuration(tooltipTask)" 
             class="mt-3 pt-3 border-t border-gray-700">
          <div class="text-sm text-amber-300 flex items-center space-x-2">
            <i class="fas fa-layer-group text-xs"></i>
            <span class="font-medium">{{ getTaskGroupName(tooltipTask.taskGroupId) }}</span>
          </div>
          <div class="text-sm text-amber-200 flex items-center space-x-2 mt-1">
            <i class="fas fa-calculator text-xs"></i>
            <span>Total grupo: {{ formatTaskDuration(getComplexGroupTotalDuration(tooltipTask)) }} ({{ getComplexGroupTaskCount(tooltipTask) }} tareas)</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Flecha del tooltip apuntando hacia arriba -->
    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-12 border-r-12 border-b-12 border-l-transparent border-r-transparent border-b-gray-900"></div>
  </div>

  <!-- Contenedor con scroll independiente para el SVG -->
  <div class="timeline-wrapper">
    <!-- Indicador de d칤as fijo en la parte superior -->
    <!-- 游꿢 CALIBRACI칍N: Usa headerDayLeftOffset y headerDayWidth en el .ts para ajustar -->
    <div #daysIndicator class="days-indicator" [style.transform]="'scale(' + zoomScale + ')'" [style.transform-origin]="'top left'">
      <svg [attr.width]="headerSvgWidth" height="60" class="days-indicator-svg" 
           [style.width.px]="headerSvgWidth" style="height: 60px; min-height: 60px;">
        <!-- Fondo del indicador -->
        <rect x="0" y="0" [attr.width]="headerSvgWidth" height="60" fill="#f9fafb" rx="6" ry="6"/>
        <line x1="0" y1="60" [attr.x2]="headerSvgWidth" y2="60" stroke="#888" stroke-width="2" />
        
        <!-- 游꿢 L칤nea de calibraci칩n: marca donde comienza headerDayLeftOffset -->
        <line [attr.x1]="headerDayLeftOffset" y1="0" 
              [attr.x2]="headerDayLeftOffset" y2="60" 
              stroke="#ef4444" stroke-width="2" stroke-dasharray="4 2" />
        
        <!-- Nombres de los d칤as - Usa getHeaderDayX() y dayColumnWidth para calibraci칩n -->
        <g *ngFor="let day of visibleWeekDays; let i = index">
          <rect [attr.x]="getHeaderDayX(i)" y="0" [attr.width]="dayColumnWidth" height="60" 
                [attr.fill]="isTodayColumn(i) ? '#e0e7ff' : '#f9fafb'" 
                rx="4" ry="4"/>
          <!-- L칤nea separadora gris entre d칤as -->
          <line [attr.x1]="getHeaderDayX(i) + dayColumnWidth" y1="5" 
                [attr.x2]="getHeaderDayX(i) + dayColumnWidth" y2="55" 
                stroke="#d1d5db" stroke-width="1" />
          <text [attr.x]="getHeaderDayX(i) + dayColumnWidth / 2" y="20" 
                [attr.font-size]="dayNameFontSize" 
                fill="#333" 
                font-weight="bold" 
                text-anchor="middle">
            {{ day.dayName }}
          </text>
          <text [attr.x]="getHeaderDayX(i) + dayColumnWidth / 2" y="40" 
                [attr.font-size]="dayNumberFontSize" 
                fill="#666" 
                text-anchor="middle">
            {{ day.monthDay }}
          </text>
        </g>
      </svg>
    </div>

    <!-- Contenedor de horas y SVG (horizontal) -->
    <div class="timeline-content-wrapper">
      <!-- Indicador de horas fijo en el lado izquierdo -->
      <div #hoursIndicator class="hours-indicator" [style.transform]="'scale(' + zoomScale + ')'" [style.transform-origin]="'top left'">
        <svg [attr.width]="60" [attr.height]="svgHeight" class="hours-indicator-svg" 
             [style.height.px]="svgHeight" [attr.viewBox]="'0 0 60 ' + svgHeight">
          <!-- Fondo del indicador -->
          <rect x="0" y="0" width="60" height="60" fill="#f9fafb" rx="6" ry="6"/>
          <line x1="0" y1="60" x2="60" y2="60" stroke="#888" stroke-width="2" />
          
          <!-- Etiquetas de horas (solo horas completas: 0-23) -->
          <g *ngFor="let hour of fullHours">
            <text x="4" 
                  [attr.y]="(hour * pixelsPerHour) - 1 + 60" 
                  [attr.font-size]="hourFontSize" 
                  fill="#666" 
                  text-anchor="start">
              {{ formatHour(hour) }}
            </text>
          </g>
        </svg>
      </div>
      
      <div #svgScrollContainer class="svg-scroll-container">
      <div class="svg-container" [style.transform]="'scale(' + zoomScale + ')'" [style.transform-origin]="'top left'" [style.width.px]="svgWidth" [style.height.px]="svgHeight">
        <svg [attr.width]="svgWidth" [attr.height]="svgHeight" [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight" 
             class="week-timeline-svg" [style.min-width.px]="svgWidth"
             (mousedown)="onSvgMouseDown($event)">
      
      <!-- Encabezado con nombres de d칤as (oculto, ahora est치 en el indicador fijo) -->
      <g transform="translate(0, 0)" style="opacity: 0; pointer-events: none;">
        <rect x="0" y="0" [attr.width]="svgWidth" height="60" fill="#f9fafb" rx="6" ry="6"/>
        <line x1="0" y1="60" [attr.x2]="svgWidth" y2="60" stroke="#888" stroke-width="2" />
        
        <!-- Nombres de los d칤as -->
        <g *ngFor="let day of visibleWeekDays; let i = index">
          <rect [attr.x]="getDayColumnX(i)" y="0" [attr.width]="dayColumnWidth" height="60" 
                [attr.fill]="isTodayColumn(i) ? '#e0e7ff' : '#f9fafb'" 
                rx="4" ry="4"/>
          <text [attr.x]="getDayColumnX(i) + dayColumnWidth / 2" y="20" 
                [attr.font-size]="dayNameFontSize" 
                fill="#333" 
                font-weight="bold" 
                text-anchor="middle">
            {{ day.dayName }}
          </text>
          <text [attr.x]="getDayColumnX(i) + dayColumnWidth / 2" y="40" 
                [attr.font-size]="dayNumberFontSize" 
                fill="#666" 
                text-anchor="middle">
            {{ day.monthDay }}
          </text>
        </g>
      </g>

      <!-- Columnas de d칤as con divisiones de horas -->
      <g *ngFor="let day of visibleWeekDays; let dayIndex = index" [attr.transform]="'translate(' + getDayColumnX(dayIndex) + ', 60)'">
        <!-- Fondo de la columna -->
        <rect x="0" y="0" [attr.width]="dayColumnWidth" [attr.height]="hoursAreaHeight" 
              [attr.fill]="isTodayColumn(dayIndex) ? '#f0f4ff' : '#ffffff'" 
              rx="4" ry="4" 
              stroke="#e5e7eb" 
              stroke-width="1"/>
        
        <!-- Sombreado para horas inactivas (0:00 - 8:00) -->
        <rect x="0" y="0" 
              [attr.width]="dayColumnWidth" 
              [attr.height]="8 * pixelsPerHour" 
              fill="#e5e7eb" 
              fill-opacity="0.7"
              rx="4" ry="4"
              class="inactive-hours-shade"/>
        
        <!-- L칤neas de horas (sin etiquetas, ahora est치n en el indicador lateral) -->
        <g *ngFor="let hour of hours">
          <line x1="0" y1="0" 
                [attr.x2]="dayColumnWidth" 
                [attr.y2]="0" 
                [attr.stroke]="'#e5e7eb'" 
                [attr.stroke-width]="hour % 2 === 0 ? '2' : '1'"
                [attr.transform]="'translate(0, ' + getHourY(hour) + ')'"/>
        </g>
        
        <!-- Tareas para este d칤a -->
        <g *ngFor="let item of getRenderableItemsForDay(dayIndex); trackBy: trackByRenderableItem"
           [class.task-overdue]="isTaskOverdue(item.task)"
           [class.task-running]="isTaskRunning(item.task)"
           [class.task-hidden]="shouldShowAsHidden(item)"
           [class.task-overlapping]="hasIntersection(item, dayIndex)"
           class="task-group">
          <!-- Borde negro exterior -->
          <rect #taskRect
                [attr.x]="getTaskX(item, dayIndex)" 
                [attr.y]="getTaskY(item, dayIndex)" 
                [attr.width]="getTaskWidth(item, dayIndex)" 
                [attr.height]="getTaskHeight(item, dayIndex)"
                [attr.fill]="getTaskColor(item.task)" 
                rx="4" ry="4" 
                [attr.fill-opacity]="getItemOpacity(item, dayIndex)" 
                stroke="rgba(0,0,0,0.6)" 
                stroke-width="1.5" 
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-day-index]="dayIndex"
                class="task-rect" />
          
          <!-- Borde blanco interior -->
          <rect [attr.x]="getTaskX(item, dayIndex)" 
                [attr.y]="getTaskY(item, dayIndex)" 
                [attr.width]="getTaskWidth(item, dayIndex)" 
                [attr.height]="getTaskHeight(item, dayIndex)"
                fill="none" 
                rx="4" ry="4" 
                stroke="rgba(255,255,255,0.8)" 
                stroke-width="1" 
                class="task-inner"
                [attr.data-task-id]="item.task.id" />
          
          <!-- Handle superior (resize inicio - m치s temprano) -->
          <rect #resizeHandleStart
                [attr.x]="getTaskX(item, dayIndex) + 4" 
                [attr.y]="getTaskY(item, dayIndex)" 
                [attr.width]="getTaskWidth(item, dayIndex) - 8" 
                height="5"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-top"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-day-index]="dayIndex" />
          <line [attr.x1]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 - 8" 
                [attr.y1]="getTaskY(item, dayIndex) + 2.5"
                [attr.x2]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 + 8" 
                [attr.y2]="getTaskY(item, dayIndex) + 2.5"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          
          <!-- Handle inferior (resize fin - m치s tarde) -->
          <rect #resizeHandleEnd
                [attr.x]="getTaskX(item, dayIndex) + 4" 
                [attr.y]="getTaskY(item, dayIndex) + getTaskHeight(item, dayIndex) - 5" 
                [attr.width]="getTaskWidth(item, dayIndex) - 8" 
                height="5"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-bottom"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-day-index]="dayIndex" />
          <line [attr.x1]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 - 8" 
                [attr.y1]="getTaskY(item, dayIndex) + getTaskHeight(item, dayIndex) - 2.5"
                [attr.x2]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 + 8" 
                [attr.y2]="getTaskY(item, dayIndex) + getTaskHeight(item, dayIndex) - 2.5"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          
          <!-- Indicador de tipo de tarea -->
          <circle *ngIf="getTaskTypeColor(item.task)" 
                  [attr.cx]="getTaskX(item, dayIndex) + 6" 
                  [attr.cy]="getTaskY(item, dayIndex) + 10" 
                  r="4" 
                  [attr.fill]="getTaskTypeColor(item.task)"
                  stroke="white" 
                  stroke-width="1"
                  class="task-type-indicator" />
          
          <!-- Texto de la tarea -->
          <text [attr.x]="getTaskX(item, dayIndex) + (getTaskTypeColor(item.task) ? 12 : 6)" 
                [attr.y]="getTaskY(item, dayIndex) + 16" 
                [attr.font-size]="taskFontSize" 
                [attr.fill]="shouldShowAsHidden(item) ? '#888' : '#111'" 
                alignment-baseline="middle"
                class="task-text">
            {{ getItemText(item, dayIndex) }}
          </text>
        </g>
        
        <!-- L칤nea de tiempo actual (si es el d칤a de hoy) -->
        <line *ngIf="isTodayColumn(dayIndex) && isCurrentHour()" 
              x1="0" 
              [attr.x2]="dayColumnWidth" 
              [attr.y1]="getCurrentHourY()" 
              [attr.y2]="getCurrentHourY()" 
              stroke="#f87171" 
              stroke-width="2" 
              stroke-dasharray="4 2" />
        
        <!-- Sombra de previsualizaci칩n -->
        <rect *ngIf="previewState.visible && previewState.dayIndex === dayIndex"
              [attr.x]="previewState.x"
              [attr.y]="previewState.y"
              [attr.width]="previewState.width"
              [attr.height]="previewState.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="4" ry="4"
              class="preview-shadow"
              pointer-events="none" />
        
        <!-- Previsualizaci칩n secundaria para movimiento entre d칤as -->
        <rect *ngIf="previewStateSecondary.visible && previewStateSecondary.dayIndex === dayIndex"
              [attr.x]="previewStateSecondary.x"
              [attr.y]="previewStateSecondary.y"
              [attr.width]="previewStateSecondary.width"
              [attr.height]="previewStateSecondary.height"
              fill="rgba(99, 102, 241, 0.15)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="4" ry="4"
              class="preview-shadow-secondary"
              pointer-events="none" />
        
        <!-- Rect치ngulo de selecci칩n de rango para crear tarea -->
        <rect *ngIf="rangeSelectionRect.visible && rangeSelectionRect.dayIndex === dayIndex"
              [attr.x]="rangeSelectionRect.x"
              [attr.y]="rangeSelectionRect.y"
              [attr.width]="rangeSelectionRect.width"
              [attr.height]="rangeSelectionRect.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="4" ry="4"
              class="range-selection-rect"
              pointer-events="none" />
      </g>
      </svg>
    </div>
      </div>
    </div>
  </div>

  <!-- Men칰 contextual -->
  <div *ngIf="showContextMenu && contextMenuTask" 
       class="context-menu"
       [style.left.px]="contextMenuX"
       [style.top.px]="contextMenuY"
       (click)="$event.stopPropagation()">
    <div class="context-menu-header">
      <span class="text-lg mr-2">{{ contextMenuTask.emoji }}</span>
      <span class="font-semibold text-sm truncate">{{ contextMenuTask.name }}</span>
    </div>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item" (click)="copyTitle()">
      <i class="fas fa-copy mr-2"></i>
      Copy Title
    </button>
    <button *ngIf="hasComplexGroup()" class="context-menu-item" (click)="copyComplexTitle()">
      <i class="fas fa-clipboard mr-2"></i>
      Copy Complex Title
    </button>
    <button *ngIf="hasComplexGroup()" class="context-menu-item" (click)="copyComplexTitleWithTitle()">
      <i class="fas fa-clipboard mr-2"></i>
      Copy Complex Title + Title
    </button>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item context-menu-item-edit" (click)="editTaskFromContextMenu()">
      <i class="fas fa-edit mr-2"></i>
      Editar tarea
    </button>
    <div class="context-menu-divider"></div>
    <button *ngIf="contextMenuTask.hidden" class="context-menu-item" (click)="toggleHiddenFromContextMenu()">
      <i class="fas fa-eye mr-2"></i>
      Mostrar
    </button>
    <button *ngIf="!contextMenuTask.hidden" class="context-menu-item" (click)="toggleHiddenFromContextMenu()">
      <i class="fas fa-eye-slash mr-2"></i>
      Ocultar
    </button>
    <div *ngIf="isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)" class="context-menu-divider"></div>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'completed'" 
            class="context-menu-item context-menu-item-completed" 
            (click)="changeStatusFromContextMenu('completed')">
      <i class="fas fa-check mr-2"></i>
      Marcar completada
    </button>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'in-progress'" 
            class="context-menu-item context-menu-item-progress" 
            (click)="changeStatusFromContextMenu('in-progress')">
      <i class="fas fa-spinner mr-2"></i>
      Marcar en progreso
    </button>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'pending'" 
            class="context-menu-item context-menu-item-pending" 
            (click)="changeStatusFromContextMenu('pending')">
      <i class="fas fa-play mr-2"></i>
      Marcar pendiente
    </button>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item delete" (click)="deleteTaskFromContextMenu()">
      <i class="fas fa-trash-alt mr-2"></i>
      Eliminar tarea
    </button>
  </div>

  <!-- Men칰 de selecci칩n de tareas superpuestas -->
  <div *ngIf="showTaskSelector && taskSelectorItems.length > 1" 
       class="task-selector-menu"
       [style.left.px]="taskSelectorX"
       [style.top.px]="taskSelectorY"
       (click)="$event.stopPropagation()">
    <div class="task-selector-header">
      <i class="fas fa-layer-group mr-2"></i>
      <span class="font-semibold text-sm">Tareas superpuestas ({{ taskSelectorItems.length }})</span>
    </div>
    <div class="task-selector-subtitle">
      Selecciona la tarea que deseas traer al frente
    </div>
    <div class="task-selector-divider"></div>
    <div class="task-selector-list">
      <button *ngFor="let item of taskSelectorItems; let i = index" 
              class="task-selector-item"
              [style.border-left-color]="getTaskColor(item.task)"
              (click)="selectTaskFromSelector(item)">
        <div class="task-selector-item-content">
          <div class="task-selector-item-name">{{ getItemShortText(item) }}</div>
          <div class="task-selector-item-time">{{ getItemTimeRange(item) }}</div>
        </div>
        <i class="fas fa-arrow-up task-selector-item-icon" title="Traer al frente"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal de desplazamiento de tiempo -->
<app-time-shift-modal 
  *ngIf="showTimeShiftModal && timeShiftTask"
  [task]="timeShiftTask"
  [fragmentIndex]="timeShiftFragmentIndex"
  [isVertical]="true"
  [suggestedDirection]="suggestedShiftDirection"
  [suggestedMinutes]="suggestedShiftMinutes"
  [taskGroups]="taskGroups"
  (confirm)="onTimeShiftConfirm($event)"
  (cancel)="onTimeShiftCancel()">
</app-time-shift-modal>

<!-- Modal de edici칩n de duraci칩n -->
<app-duration-edit-modal
  *ngIf="showDurationModal && durationTask"
  [task]="durationTask"
  [fragmentIndex]="durationFragmentIndex"
  [suggestedAdjustStart]="suggestedAdjustStart"
  [suggestedDurationMinutes]="suggestedDurationMinutes"
  [taskGroups]="taskGroups"
  (confirm)="onDurationConfirm($event)"
  (cancel)="onDurationCancel()">
</app-duration-edit-modal>

