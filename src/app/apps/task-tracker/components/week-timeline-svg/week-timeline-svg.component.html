<div #containerRef class="week-timeline-container w-full overflow-x-auto relative">
  <!-- Toggle de modo de coloreado (solo visible cuando hay ambiente enfocado) -->
  <div *ngIf="focusedEnvironmentId" class="color-mode-toggle mb-3 flex items-center justify-center gap-2 bg-white rounded-lg p-2 shadow-sm border">
    <button 
      (click)="toggleColorMode()"
      class="toggle-button flex items-center gap-2 px-4 py-2 rounded-md transition-all duration-200"
      [class.active-environment]="colorMode === 'environment'"
      [class.active-tasktype]="colorMode === 'taskType'"
      title="Cambiar modo de coloreado">
      <i class="fas" [class.fa-layer-group]="colorMode === 'environment'" [class.fa-tag]="colorMode === 'taskType'"></i>
      <span class="text-sm font-medium">
        {{ colorMode === 'environment' ? 'Color por Ambiente' : 'Color por Tipo de Tarea' }}
      </span>
    </button>
  </div>
  
  <!-- Controles de Navegación de Semana -->
  <div class="week-navigation mb-4 flex flex-col md:flex-row items-center justify-between bg-white rounded-lg p-3 shadow-sm border gap-3">
    <!-- Primera fila: Navegador de semanas -->
    <div class="flex items-center space-x-2 w-full md:w-auto justify-center md:justify-start">
      <button (click)="goToPreviousWeek()" 
              class="nav-btn flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
              title="Semana anterior">
        <i class="fas fa-chevron-left text-sm text-gray-600"></i>
      </button>
      
      <div class="week-display text-sm font-semibold text-gray-700 px-2 text-center">
        {{ formatWeekRange() }}
      </div>
      
      <button (click)="goToNextWeek()" 
              class="nav-btn flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
              title="Semana siguiente">
        <i class="fas fa-chevron-right text-sm text-gray-600"></i>
      </button>
    </div>
    
    <!-- Segunda fila: Selector y botón Esta Semana -->
    <div class="flex items-center space-x-3 w-full md:w-auto justify-center md:justify-end">
      <div class="w-48 flex-shrink-0">
        <app-android-date-picker
          [ngModel]="getWeekInputValue()"
          (dateChange)="onWeekDateChange($event)"
          label="Seleccionar semana"
          placeholder="Seleccionar semana"
          class="date-picker">
        </app-android-date-picker>
      </div>
      
      <button (click)="goToCurrentWeek()" 
              [class.bg-indigo-100]="isCurrentWeek()"
              [class.text-indigo-700]="isCurrentWeek()"
              [class.bg-gray-100]="!isCurrentWeek()"
              [class.text-gray-700]="!isCurrentWeek()"
              class="nav-btn px-3 py-1 rounded-md text-sm font-medium hover:bg-indigo-50 transition-colors flex-shrink-0"
              title="Ir a esta semana">
        Esta Semana
      </button>
    </div>
  </div>

  <!-- Tooltip para mostrar información completa de la tarea -->
  <div *ngIf="showTooltip && tooltipTask" 
       class="tooltip-container absolute top-[150px] left-1/2 transform -translate-x-1/2 z-50 bg-gray-900 text-white px-6 py-5 rounded-xl shadow-2xl max-w-2xl min-w-[400px]">
    <div class="flex items-start space-x-4">
      <span class="text-3xl flex-shrink-0">{{ tooltipTask.emoji }}</span>
      <div *ngIf="getTaskTypeColor(tooltipTask)" 
           class="w-5 h-5 rounded-full border-2 border-white shadow-sm flex-shrink-0 mt-1" 
           [style.background-color]="getTaskTypeColor(tooltipTask)"></div>
      <div class="flex-1">
        <div class="font-bold text-lg mb-2">{{ getTaskDisplayName(tooltipTask) }}</div>
        <div *ngIf="tooltipTask.description" class="text-sm text-gray-200 mt-2 mb-3 leading-relaxed">{{ tooltipTask.description }}</div>
        <div class="flex flex-wrap gap-4 mt-3">
          <div class="text-sm text-gray-300 flex items-center space-x-2">
            <i class="fas fa-clock text-xs"></i>
            <span>{{ formatTaskTime(tooltipTask.start) }} - {{ formatTaskTime(tooltipTask.end) }}</span>
          </div>
          <div *ngIf="getTaskDuration(tooltipTask)" class="text-sm text-purple-300 flex items-center space-x-2">
            <i class="fas fa-hourglass-half text-xs"></i>
            <span>Duración: {{ formatTaskDuration(getTaskDuration(tooltipTask)) }}</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Flecha del tooltip apuntando hacia arriba -->
    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-12 border-r-12 border-b-12 border-l-transparent border-r-transparent border-b-gray-900"></div>
  </div>

  <!-- Contenedor centrado para el SVG -->
  <div class="svg-container">
    <svg [attr.width]="svgWidth" [attr.height]="svgHeight" [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight" 
         class="week-timeline-svg" [style.min-width.px]="svgWidth">
      
      <!-- Encabezado con nombres de días -->
      <g transform="translate(0, 0)">
        <rect x="0" y="0" [attr.width]="svgWidth" height="60" fill="#f9fafb" rx="6" ry="6"/>
        <line x1="0" y1="60" [attr.x2]="svgWidth" y2="60" stroke="#888" stroke-width="2" />
        
        <!-- Nombres de los días -->
        <g *ngFor="let day of weekDays; let i = index">
          <rect [attr.x]="getDayColumnX(i)" y="0" [attr.width]="dayColumnWidth" height="60" 
                [attr.fill]="isTodayColumn(i) ? '#e0e7ff' : '#f9fafb'" 
                rx="4" ry="4"/>
          <text [attr.x]="getDayColumnX(i) + dayColumnWidth / 2" y="20" 
                [attr.font-size]="dayNameFontSize" 
                fill="#333" 
                font-weight="bold" 
                text-anchor="middle">
            {{ day.dayName }}
          </text>
          <text [attr.x]="getDayColumnX(i) + dayColumnWidth / 2" y="40" 
                [attr.font-size]="dayNumberFontSize" 
                fill="#666" 
                text-anchor="middle">
            {{ day.monthDay }}
          </text>
        </g>
      </g>

      <!-- Columnas de días con divisiones de horas -->
      <g *ngFor="let day of weekDays; let dayIndex = index" [attr.transform]="'translate(' + getDayColumnX(dayIndex) + ', 60)'">
        <!-- Fondo de la columna -->
        <rect x="0" y="0" [attr.width]="dayColumnWidth" [attr.height]="hoursAreaHeight" 
              [attr.fill]="isTodayColumn(dayIndex) ? '#f0f4ff' : '#ffffff'" 
              rx="4" ry="4" 
              stroke="#e5e7eb" 
              stroke-width="1"/>
        
        <!-- Líneas de horas y etiquetas -->
        <g *ngFor="let hour of hours">
          <line x1="0" y1="0" 
                [attr.x2]="dayColumnWidth" 
                [attr.y2]="0" 
                [attr.stroke]="'#e5e7eb'" 
                [attr.stroke-width]="hour % 2 === 0 ? '2' : '1'"
                [attr.transform]="'translate(0, ' + getHourY(hour) + ')'"/>
          
          <text *ngIf="dayIndex === 0"
                x="4" 
                [attr.y]="getHourY(hour) - 1" 
                [attr.font-size]="hourFontSize" 
                fill="#666" 
                text-anchor="start"
                [attr.transform]="'translate(0, ' + getHourY(hour) + ')'">
            {{ formatHour(hour) }}
          </text>
        </g>
        
        <!-- Tareas para este día -->
        <g *ngFor="let item of getRenderableItemsForDay(dayIndex); trackBy: trackByRenderableItem"
           [class.task-overdue]="isTaskOverdue(item.task)"
           [class.task-running]="isTaskRunning(item.task)"
           [class.task-hidden]="shouldShowAsHidden(item)"
           class="task-group">
          <!-- Borde negro exterior -->
          <rect #taskRect
                [attr.x]="getTaskX(item, dayIndex)" 
                [attr.y]="getTaskY(item, dayIndex)" 
                [attr.width]="getTaskWidth(item, dayIndex)" 
                [attr.height]="getTaskHeight(item, dayIndex)"
                [attr.fill]="getTaskColor(item.task)" 
                rx="4" ry="4" 
                [attr.fill-opacity]="getItemOpacity(item, dayIndex)" 
                stroke="rgba(0,0,0,0.6)" 
                stroke-width="1.5" 
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-day-index]="dayIndex"
                class="task-rect" />
          
          <!-- Borde blanco interior -->
          <rect [attr.x]="getTaskX(item, dayIndex)" 
                [attr.y]="getTaskY(item, dayIndex)" 
                [attr.width]="getTaskWidth(item, dayIndex)" 
                [attr.height]="getTaskHeight(item, dayIndex)"
                fill="none" 
                rx="4" ry="4" 
                stroke="rgba(255,255,255,0.8)" 
                stroke-width="1" 
                class="task-inner"
                [attr.data-task-id]="item.task.id" />
          
          <!-- Handle superior (resize inicio - más temprano) -->
          <rect #resizeHandleStart
                [attr.x]="getTaskX(item, dayIndex) + 4" 
                [attr.y]="getTaskY(item, dayIndex)" 
                [attr.width]="getTaskWidth(item, dayIndex) - 8" 
                height="5"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-top"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-day-index]="dayIndex" />
          <line [attr.x1]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 - 8" 
                [attr.y1]="getTaskY(item, dayIndex) + 2.5"
                [attr.x2]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 + 8" 
                [attr.y2]="getTaskY(item, dayIndex) + 2.5"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          
          <!-- Handle inferior (resize fin - más tarde) -->
          <rect #resizeHandleEnd
                [attr.x]="getTaskX(item, dayIndex) + 4" 
                [attr.y]="getTaskY(item, dayIndex) + getTaskHeight(item, dayIndex) - 5" 
                [attr.width]="getTaskWidth(item, dayIndex) - 8" 
                height="5"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-bottom"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-day-index]="dayIndex" />
          <line [attr.x1]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 - 8" 
                [attr.y1]="getTaskY(item, dayIndex) + getTaskHeight(item, dayIndex) - 2.5"
                [attr.x2]="getTaskX(item, dayIndex) + getTaskWidth(item, dayIndex)/2 + 8" 
                [attr.y2]="getTaskY(item, dayIndex) + getTaskHeight(item, dayIndex) - 2.5"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          
          <!-- Indicador de tipo de tarea -->
          <circle *ngIf="getTaskTypeColor(item.task)" 
                  [attr.cx]="getTaskX(item, dayIndex) + 6" 
                  [attr.cy]="getTaskY(item, dayIndex) + 10" 
                  r="4" 
                  [attr.fill]="getTaskTypeColor(item.task)"
                  stroke="white" 
                  stroke-width="1"
                  class="task-type-indicator" />
          
          <!-- Texto de la tarea -->
          <text [attr.x]="getTaskX(item, dayIndex) + (getTaskTypeColor(item.task) ? 12 : 6)" 
                [attr.y]="getTaskY(item, dayIndex) + 16" 
                [attr.font-size]="taskFontSize" 
                [attr.fill]="shouldShowAsHidden(item) ? '#888' : '#111'" 
                alignment-baseline="middle"
                class="task-text">
            {{ getItemText(item, dayIndex) }}
          </text>
        </g>
        
        <!-- Línea de tiempo actual (si es el día de hoy) -->
        <line *ngIf="isTodayColumn(dayIndex) && isCurrentHour()" 
              x1="0" 
              [attr.x2]="dayColumnWidth" 
              [attr.y1]="getCurrentHourY()" 
              [attr.y2]="getCurrentHourY()" 
              stroke="#f87171" 
              stroke-width="2" 
              stroke-dasharray="4 2" />
        
        <!-- Sombra de previsualización -->
        <rect *ngIf="previewState.visible && previewState.dayIndex === dayIndex"
              [attr.x]="previewState.x"
              [attr.y]="previewState.y"
              [attr.width]="previewState.width"
              [attr.height]="previewState.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="4" ry="4"
              class="preview-shadow"
              pointer-events="none" />
      </g>
    </svg>
  </div>

  <!-- Menú contextual -->
  <div *ngIf="showContextMenu && contextMenuTask" 
       class="context-menu"
       [style.left.px]="contextMenuX"
       [style.top.px]="contextMenuY"
       (click)="$event.stopPropagation()">
    <div class="context-menu-header">
      <span class="text-lg mr-2">{{ contextMenuTask.emoji }}</span>
      <span class="font-semibold text-sm truncate">{{ contextMenuTask.name }}</span>
    </div>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item context-menu-item-edit" (click)="editTaskFromContextMenu()">
      <i class="fas fa-edit mr-2"></i>
      Editar tarea
    </button>
    <div class="context-menu-divider"></div>
    <button *ngIf="contextMenuTask.hidden" class="context-menu-item" (click)="toggleHiddenFromContextMenu()">
      <i class="fas fa-eye mr-2"></i>
      Mostrar
    </button>
    <button *ngIf="!contextMenuTask.hidden" class="context-menu-item" (click)="toggleHiddenFromContextMenu()">
      <i class="fas fa-eye-slash mr-2"></i>
      Ocultar
    </button>
    <div *ngIf="isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)" class="context-menu-divider"></div>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'completed'" 
            class="context-menu-item context-menu-item-completed" 
            (click)="changeStatusFromContextMenu('completed')">
      <i class="fas fa-check mr-2"></i>
      Marcar completada
    </button>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'in-progress'" 
            class="context-menu-item context-menu-item-progress" 
            (click)="changeStatusFromContextMenu('in-progress')">
      <i class="fas fa-spinner mr-2"></i>
      Marcar en progreso
    </button>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'pending'" 
            class="context-menu-item context-menu-item-pending" 
            (click)="changeStatusFromContextMenu('pending')">
      <i class="fas fa-play mr-2"></i>
      Marcar pendiente
    </button>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item delete" (click)="deleteTaskFromContextMenu()">
      <i class="fas fa-trash-alt mr-2"></i>
      Eliminar tarea
    </button>
  </div>

  <!-- Menú de selección de tareas superpuestas -->
  <div *ngIf="showTaskSelector && taskSelectorItems.length > 1" 
       class="task-selector-menu"
       [style.left.px]="taskSelectorX"
       [style.top.px]="taskSelectorY"
       (click)="$event.stopPropagation()">
    <div class="task-selector-header">
      <i class="fas fa-layer-group mr-2"></i>
      <span class="font-semibold text-sm">Tareas superpuestas ({{ taskSelectorItems.length }})</span>
    </div>
    <div class="task-selector-subtitle">
      Selecciona la tarea que deseas traer al frente
    </div>
    <div class="task-selector-divider"></div>
    <div class="task-selector-list">
      <button *ngFor="let item of taskSelectorItems; let i = index" 
              class="task-selector-item"
              [style.border-left-color]="getTaskColor(item.task)"
              (click)="selectTaskFromSelector(item)">
        <div class="task-selector-item-content">
          <div class="task-selector-item-name">{{ getItemShortText(item) }}</div>
          <div class="task-selector-item-time">{{ getItemTimeRange(item) }}</div>
        </div>
        <i class="fas fa-arrow-up task-selector-item-icon" title="Traer al frente"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal de desplazamiento de tiempo -->
<app-time-shift-modal 
  *ngIf="showTimeShiftModal && timeShiftTask"
  [task]="timeShiftTask"
  [fragmentIndex]="timeShiftFragmentIndex"
  [isVertical]="true"
  [suggestedDirection]="suggestedShiftDirection"
  [suggestedMinutes]="suggestedShiftMinutes"
  (confirm)="onTimeShiftConfirm($event)"
  (cancel)="onTimeShiftCancel()">
</app-time-shift-modal>

<!-- Modal de edición de duración -->
<app-duration-edit-modal
  *ngIf="showDurationModal && durationTask"
  [task]="durationTask"
  [fragmentIndex]="durationFragmentIndex"
  [suggestedAdjustStart]="suggestedAdjustStart"
  [suggestedDurationMinutes]="suggestedDurationMinutes"
  (confirm)="onDurationConfirm($event)"
  (cancel)="onDurationCancel()">
</app-duration-edit-modal>

