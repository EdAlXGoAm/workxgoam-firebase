<!-- Modal principal -->
<div *ngIf="showModal" 
     class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
     (click)="closeModal()">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col"
       (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="p-4 md:p-5 border-b border-gray-200 flex-shrink-0"
         [style.background-color]="environmentColor ? environmentColor + '15' : '#f5f3ff'">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold flex items-center gap-2"
            [style.color]="environmentColor || '#4f46e5'">
          <span *ngIf="environmentEmoji" class="text-xl">{{ environmentEmoji }}</span>
          <i *ngIf="!environmentEmoji" class="fas fa-layer-group"></i>
          <span>{{ environmentName || 'Ambiente' }}</span>
        </h3>
        <button (click)="closeModal()" 
                class="text-gray-500 hover:text-gray-700 transition-colors p-1">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <p class="text-xs text-gray-600 mt-2">
        <i class="fas fa-info-circle mr-1"></i>
        Explora y edita tareas de este ambiente. Click derecho (o mantener presionado en m칩vil) para editar emoji o nombre.
      </p>
    </div>
    
    <!-- Filtros de fecha -->
    <div class="p-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
      <!-- Toggle "Todos" -->
      <div class="flex items-center justify-between mb-3">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" 
                 [checked]="showAllTasks"
                 (change)="onToggleAllTasks()"
                 class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
          <span class="text-sm font-medium text-gray-700">Mostrar todas las tareas</span>
        </label>
        <span class="text-xs text-gray-500">
          {{ filteredTasks.length }} tarea(s)
        </span>
      </div>
      
      <!-- Selectores de fecha (deshabilitados si "Todos" est치 activo) -->
      <div class="flex flex-col sm:flex-row gap-3"
           [class.opacity-50]="showAllTasks"
           [class.pointer-events-none]="showAllTasks">
        <div class="flex-1">
          <label class="block text-xs font-medium text-gray-600 mb-1">
            <i class="fas fa-calendar-alt mr-1"></i>Desde
          </label>
          <input type="date"
                 [(ngModel)]="dateFrom"
                 (change)="onDateChange()"
                 class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex-1">
          <label class="block text-xs font-medium text-gray-600 mb-1">
            <i class="fas fa-calendar-alt mr-1"></i>Hasta
          </label>
          <input type="date"
                 [(ngModel)]="dateTo"
                 (change)="onDateChange()"
                 class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
      </div>
      
      <!-- Filtro de proyectos -->
      <div *ngIf="environmentProjects.length > 0" class="mt-3 pt-3 border-t border-gray-200">
        <!-- Toggle para mostrar/ocultar filtro -->
        <button type="button"
                (click)="toggleProjectFilter()"
                class="flex items-center justify-between w-full text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
          <span class="flex items-center gap-2">
            <i class="fas fa-folder"></i>
            Filtrar por proyecto
            <span class="text-xs font-normal text-gray-500">({{ selectedProjectsCount }}/{{ environmentProjects.length }})</span>
          </span>
          <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"
             [class.rotate-180]="showProjectFilter"></i>
        </button>
        
        <!-- Lista de proyectos (expandible) -->
        <div *ngIf="showProjectFilter" class="mt-3 space-y-2">
          <!-- Botones de acci칩n r치pida -->
          <div class="flex gap-2 mb-2">
            <button type="button"
                    (click)="selectAllProjects()"
                    [disabled]="allProjectsSelected"
                    class="text-xs px-2 py-1 text-indigo-600 hover:bg-indigo-50 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-check-double mr-1"></i>Todos
            </button>
            <button type="button"
                    (click)="deselectAllProjects()"
                    [disabled]="noProjectsSelected"
                    class="text-xs px-2 py-1 text-gray-600 hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-times mr-1"></i>Ninguno
            </button>
          </div>
          
          <!-- Lista de checkboxes -->
          <div class="max-h-32 overflow-y-auto space-y-1 pr-1">
            <label *ngFor="let project of environmentProjects"
                   class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors"
                   [class.bg-indigo-50]="selectedProjects[project.id]"
                   [class.border]="selectedProjects[project.id]"
                   [class.border-indigo-200]="selectedProjects[project.id]">
              <input type="checkbox"
                     [checked]="selectedProjects[project.id]"
                     (change)="toggleProjectSelection(project.id)"
                     class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
              <span class="w-3 h-3 rounded-full flex-shrink-0"
                    [style.background-color]="project.color || '#6366f1'"></span>
              <span class="text-sm text-gray-700 truncate flex-1">{{ project.name }}</span>
            </label>
          </div>
          
          <!-- Mensaje si no hay proyectos seleccionados -->
          <div *ngIf="noProjectsSelected" class="text-xs text-amber-600 flex items-center gap-1 mt-1">
            <i class="fas fa-exclamation-triangle"></i>
            Selecciona al menos un proyecto para ver tareas
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contenido scrollable con tareas -->
    <div class="flex-1 overflow-y-auto p-4">
      <!-- Grupos de tareas (tareas con nombre repetido) -->
      <div *ngIf="multipleTaskGroups.length > 0" class="mb-4">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2">
          <i class="fas fa-layer-group"></i>
          Tareas agrupadas ({{ multipleTaskGroups.length }})
        </div>
        <div class="space-y-2">
          <div *ngFor="let group of multipleTaskGroups" class="border border-gray-200 rounded-lg overflow-hidden">
            <!-- Header del grupo -->
            <div (click)="toggleTaskGroup(group.name)"
                 (contextmenu)="onGroupContextMenu($event, group.name)"
                 (touchstart)="onGroupTouchStart($event, group.name)"
                 (touchend)="onGroupTouchEnd()"
                 (touchmove)="onGroupTouchMove()"
                 class="p-3 bg-gray-50 hover:bg-gray-100 cursor-pointer flex items-center gap-3 transition-colors">
              <span class="text-2xl flex-shrink-0">{{ group.emoji }}</span>
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-gray-900 truncate">{{ group.name }}</h4>
                <span class="text-xs text-gray-500">{{ group.tasks.length }} tareas</span>
              </div>
              <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"
                 [class.rotate-180]="isTaskGroupExpanded(group.name)"></i>
            </div>
            
            <!-- Tareas del grupo (expandibles) -->
            <div *ngIf="isTaskGroupExpanded(group.name)" class="border-t border-gray-200 bg-white">
              <div *ngFor="let item of group.tasks; let isLast = last"
                   (contextmenu)="onRecentTaskContextMenu($event, item.originalIndex)"
                   (touchstart)="onRecentTaskTouchStart($event, item.originalIndex)"
                   (touchend)="onRecentTaskTouchEnd()"
                   (touchmove)="onRecentTaskTouchMove()"
                   class="p-3 pl-6 hover:bg-indigo-50 cursor-pointer transition-colors"
                   [class.border-b]="!isLast"
                   [class.border-gray-100]="!isLast"
                   [class.ring-2]="editingTaskIndex === item.originalIndex"
                   [class.ring-indigo-500]="editingTaskIndex === item.originalIndex"
                   [class.ring-inset]="editingTaskIndex === item.originalIndex">
                <div class="flex items-start gap-3">
                  <!-- Emoji - editable -->
                  <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'emoji'; else groupNormalEmoji">
                    <button type="button" 
                            (click)="showEmojiPickerForEdit = true; $event.stopPropagation()"
                            class="text-xl flex-shrink-0 p-1 rounded hover:bg-indigo-100 border-2 border-indigo-400">
                      {{ editingValue || '游닇' }}
                    </button>
                  </ng-container>
                  <ng-template #groupNormalEmoji>
                    <span class="text-xl flex-shrink-0 opacity-50">{{ item.task.emoji || '游닇' }}</span>
                  </ng-template>
                  
                  <div class="flex-1 min-w-0">
                    <!-- Nombre - editable -->
                    <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'name'; else groupNormalName">
                      <div class="flex items-center gap-2">
                        <input type="text"
                               id="edit-task-name-input-env"
                               [(ngModel)]="editingValue"
                               (keydown)="onEditNameKeydown($event)"
                               (blur)="saveQuickEdit()"
                               (click)="$event.stopPropagation()"
                               class="flex-1 px-2 py-1 text-sm border border-indigo-400 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Nombre de la tarea">
                        <button type="button" 
                                (click)="saveQuickEdit(); $event.stopPropagation()"
                                class="p-1 text-green-600 hover:bg-green-100 rounded"
                                [disabled]="isSavingQuickEdit">
                          <i class="fas fa-check"></i>
                        </button>
                        <button type="button" 
                                (click)="cancelQuickEdit(); $event.stopPropagation()"
                                class="p-1 text-gray-500 hover:bg-gray-100 rounded">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </ng-container>
                    <ng-template #groupNormalName>
                      <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-600">
                        <span *ngIf="item.task.start" class="flex items-center">
                          <i class="fas fa-play text-green-500 mr-1"></i>
                          {{ formatRecentTaskDate(item.task.start) }}
                        </span>
                        <span *ngIf="item.task.end" class="flex items-center">
                          <i class="fas fa-stop text-red-500 mr-1"></i>
                          {{ formatRecentTaskDate(item.task.end) }}
                        </span>
                        <span *ngIf="item.task.duration" class="flex items-center font-medium text-indigo-600">
                          <i class="fas fa-clock mr-1"></i>
                          {{ formatDuration(item.task.duration) }}
                        </span>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tareas unitarias (nombre 칰nico) -->
      <div *ngIf="singleTasks.length > 0">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2">
          <i class="fas fa-tasks"></i>
          Tareas individuales ({{ singleTasks.length }})
        </div>
        <div class="space-y-2">
          <div *ngFor="let item of singleTasks" 
               (contextmenu)="onRecentTaskContextMenu($event, item.originalIndex)"
               (touchstart)="onRecentTaskTouchStart($event, item.originalIndex)"
               (touchend)="onRecentTaskTouchEnd()"
               (touchmove)="onRecentTaskTouchMove()"
               class="p-3 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-colors"
               [class.ring-2]="editingTaskIndex === item.originalIndex"
               [class.ring-indigo-500]="editingTaskIndex === item.originalIndex">
            <div class="flex items-start gap-3">
              <!-- Emoji - editable -->
              <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'emoji'; else singleNormalEmoji">
                <button type="button" 
                        (click)="showEmojiPickerForEdit = true; $event.stopPropagation()"
                        class="text-2xl flex-shrink-0 p-1 rounded hover:bg-indigo-100 border-2 border-indigo-400">
                  {{ editingValue || '游닇' }}
                </button>
              </ng-container>
              <ng-template #singleNormalEmoji>
                <span class="text-2xl flex-shrink-0">{{ item.task.emoji || '游닇' }}</span>
              </ng-template>
              
              <div class="flex-1 min-w-0">
                <!-- Nombre - editable -->
                <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'name'; else singleNormalName">
                  <div class="flex items-center gap-2">
                    <input type="text"
                           id="edit-task-name-input-env"
                           [(ngModel)]="editingValue"
                           (keydown)="onEditNameKeydown($event)"
                           (blur)="saveQuickEdit()"
                           (click)="$event.stopPropagation()"
                           class="flex-1 px-2 py-1 text-sm border border-indigo-400 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Nombre de la tarea">
                    <button type="button" 
                            (click)="saveQuickEdit(); $event.stopPropagation()"
                            class="p-1 text-green-600 hover:bg-green-100 rounded"
                            [disabled]="isSavingQuickEdit">
                      <i class="fas fa-check"></i>
                    </button>
                    <button type="button" 
                            (click)="cancelQuickEdit(); $event.stopPropagation()"
                            class="p-1 text-gray-500 hover:bg-gray-100 rounded">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </ng-container>
                <ng-template #singleNormalName>
                  <h4 class="font-medium text-gray-900 truncate">{{ item.task.name }}</h4>
                </ng-template>
                
                <!-- Fechas de inicio y fin -->
                <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-500 mt-1">
                  <span *ngIf="item.task.start" class="flex items-center">
                    <i class="fas fa-play text-green-500 mr-1"></i>
                    {{ formatRecentTaskDate(item.task.start) }}
                  </span>
                  <span *ngIf="item.task.end" class="flex items-center">
                    <i class="fas fa-stop text-red-500 mr-1"></i>
                    {{ formatRecentTaskDate(item.task.end) }}
                  </span>
                  <span *ngIf="item.task.duration" class="flex items-center font-medium text-indigo-600">
                    <i class="fas fa-clock mr-1"></i>
                    {{ formatDuration(item.task.duration) }}
                  </span>
                </div>
                <div *ngIf="item.task.description" class="text-xs text-gray-600 mt-1 line-clamp-2">
                  {{ item.task.description }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mensaje cuando no hay tareas -->
      <div *ngIf="filteredTasks.length === 0" class="text-center text-gray-500 py-8">
        <i class="fas fa-inbox text-3xl mb-2 text-gray-300"></i>
        <p>No hay tareas en este rango de fechas</p>
        <p class="text-xs mt-1">Prueba con otro rango o activa "Mostrar todas"</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmaci칩n para cargar todas las tareas -->
<div *ngIf="showConfirmAllTasks" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
     (click)="cancelLoadAllTasks()">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6"
       (click)="$event.stopPropagation()">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
      </div>
      <div>
        <h3 class="font-bold text-gray-900">Muchas tareas</h3>
        <p class="text-sm text-gray-600">{{ totalTasksCount }} tareas encontradas</p>
      </div>
    </div>
    <p class="text-sm text-gray-600 mb-4">
      Este ambiente tiene m치s de 100 tareas. Cargarlas todas puede tomar un momento. 쮻eseas continuar?
    </p>
    <div class="flex gap-3">
      <button (click)="cancelLoadAllTasks()"
              class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
        Cancelar
      </button>
      <button (click)="confirmLoadAllTasks()"
              class="flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
        Cargar todas
      </button>
    </div>
  </div>
</div>

<!-- Men칰 contextual para tareas -->
<div *ngIf="showContextMenu" 
     class="fixed z-[100] bg-white rounded-lg shadow-xl border border-gray-200 py-1 min-w-[160px]"
     [style.left.px]="contextMenuX"
     [style.top.px]="contextMenuY"
     (click)="$event.stopPropagation()">
  <button type="button"
          (click)="startEditEmoji()"
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
    <i class="fas fa-smile text-indigo-500"></i>
    Editar emoji
  </button>
  <button type="button"
          (click)="startEditName()"
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
    <i class="fas fa-edit text-indigo-500"></i>
    Editar nombre
  </button>
</div>

<!-- Overlay para cerrar men칰 contextual -->
<div *ngIf="showContextMenu" 
     class="fixed inset-0 z-[99]"
     (click)="closeContextMenu()">
</div>

<!-- Men칰 contextual para grupos de tareas -->
<div *ngIf="showGroupContextMenu" 
     class="fixed z-[100] bg-white rounded-lg shadow-xl border border-gray-200 py-1 min-w-[200px]"
     [style.left.px]="groupContextMenuX"
     [style.top.px]="groupContextMenuY"
     (click)="$event.stopPropagation()">
  <button type="button"
          (click)="startEditGroupEmoji()"
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
    <i class="fas fa-smile text-indigo-500"></i>
    Cambiar emoji a todas
  </button>
</div>

<!-- Overlay para cerrar men칰 contextual de grupo -->
<div *ngIf="showGroupContextMenu" 
     class="fixed inset-0 z-[99]"
     (click)="closeGroupContextMenu()">
</div>

<!-- Modal de emoji picker para grupos -->
<app-emoji-picker
  [showModal]="showEmojiPickerForGroup"
  [currentEmoji]="editingValue || '游닇'"
  [suggestedEmojis]="groupSuggestedEmojis"
  title="Emoji para el grupo"
  subtitle="Se aplicar치 a todas las tareas del grupo &quot;{{ contextMenuGroupName }}&quot;"
  (emojiSelected)="selectEmojiForGroup($event)"
  (closed)="closeEmojiPickerForGroup()">
</app-emoji-picker>

<!-- Modal de emoji picker para edici칩n r치pida -->
<app-emoji-picker
  [showModal]="showEmojiPickerForEdit"
  [currentEmoji]="editingValue || '游닇'"
  title="Seleccionar Emoji"
  (emojiSelected)="selectEmojiForEdit($event)"
  (closed)="closeEmojiPickerForEdit()">
</app-emoji-picker>
