<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] md:max-h-[95vh] overflow-hidden flex flex-col relative" (click)="handleModalClick($event)">
    <!-- Burbuja flotante para tareas recientes - posicionada cerca del bot贸n de cerrar -->
    <div *ngIf="showRecentTasksSelector && recentTasks.length > 0 && !isEditing" 
         class="absolute z-[60] recent-tasks-bubble"
         (click)="toggleRecentTasksModal()">
      <div class="w-12 h-12 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center cursor-pointer hover:bg-indigo-700 transition-all hover:scale-110 relative">
        <i class="fas fa-history text-lg"></i>
        <span *ngIf="recentTasks.length > 0" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs font-bold flex items-center justify-center border-2 border-white">
          {{ recentTasks.length > 9 ? '9+' : recentTasks.length }}
        </span>
      </div>
    </div>
    
    <div class="px-4 pt-3 pb-2 md:px-6 md:pt-4 md:pb-2 border-b border-gray-200 flex-shrink-0">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-bold">{{ isEditing ? 'Editar Tarea' : 'Nueva Tarea' }}</h3>
        <button (click)="closeModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <!-- Selector de prioridad compacto en el header -->
      <app-priority-selector
        [(ngModel)]="task.priority"
        name="priorityHeader">
      </app-priority-selector>
    </div>
    
    <!-- Indicador de carga -->
    <div *ngIf="isLoading" class="flex-1 flex items-center justify-center p-8">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-600 font-medium">Cargando datos...</p>
        <p class="text-gray-500 text-sm mt-2">Preparando el formulario</p>
      </div>
    </div>
    
    <!-- Contenido del formulario -->
    <div *ngIf="!isLoading" class="flex-1 overflow-y-auto">
      <div class="px-4 pt-2 pb-4 md:px-6 md:pt-2 md:pb-6">
        
        <form [id]="formId" (ngSubmit)="saveTask()" class="space-y-4">
          
        <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ambiente</label>
              <div class="flex gap-0">
                <!-- Selector personalizado para todas las resoluciones -->
                <div class="flex-1">
                  <app-custom-select
                    #environmentSelect
                    [options]="environmentOptions"
                    [(ngModel)]="task.environment"
                    (optionSelected)="onEnvironmentSelectCustom($event)"
                    name="environmentCustom"
                    placeholder="Seleccionar ambiente"
                    [roundedRight]="false">
                  </app-custom-select>
                </div>
                
                <button type="button" (click)="openEnvironmentModal.emit()" class="px-3 py-2 bg-gray-200 border border-l-0 rounded-r-lg flex-shrink-0">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Proyecto</label>
              <div class="flex gap-0">
                <!-- Selector personalizado para todas las resoluciones -->
                <div class="flex-1">
                  <app-custom-select
                    #projectSelect
                    [options]="projectOptions"
                    [(ngModel)]="task.project"
                    (optionSelected)="onProjectSelectCustom($event)"
                    name="projectCustom"
                    placeholder="Seleccionar proyecto"
                    [disabled]="!task.environment || selectableProjects.length === 0"
                    [roundedRight]="false">
                  </app-custom-select>
                </div>
                
                <button type="button" (click)="openProjectModal.emit()" class="px-3 py-2 bg-gray-200 border border-l-0 rounded-r-lg flex-shrink-0">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Tipo de tarea y Tarea Compleja en la misma fila -->
          <div class="grid grid-cols-2 gap-4">
            <!-- Selector de tipo de tarea -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Tarea</label>
              <div class="flex gap-0">
                <div class="flex-1">
                  <app-custom-select
                    #taskTypeSelect
                    [options]="taskTypeOptions"
                    [(ngModel)]="task.type"
                    (optionSelected)="onTaskTypeSelectCustom($event)"
                    name="taskTypeCustom"
                    placeholder="Sin tipo"
                    [disabled]="!task.project || isLoadingTaskTypes"
                    [roundedRight]="false">
                  </app-custom-select>
                </div>
                <button 
                  type="button" 
                  (click)="openTaskTypeModal.emit()" 
                  class="px-3 py-2 bg-gray-200 border border-l-0 rounded-r-lg flex-shrink-0"
                  [disabled]="!task.project || isLoadingTaskTypes"
                  [title]="task.project ? 'Agregar tipo de tarea' : 'Selecciona un proyecto primero'">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <!-- Mostrar informaci贸n del tipo seleccionado -->
              <div *ngIf="task.type && selectableTaskTypes.length > 0" class="mt-1 flex items-center gap-2">
                <div *ngFor="let type of selectableTaskTypes">
                  <div *ngIf="type.id === task.type" class="flex items-center gap-1">
                    <div class="w-3 h-3 rounded-full border border-white shadow-sm" [style.background-color]="type.color"></div>
                    <span class="text-xs text-gray-600">{{type.name}}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Grupo de Tarea Compleja -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tarea Compleja</label>
              <app-task-group-select
                [projectId]="task.project"
                [taskGroups]="taskGroups"
                [value]="task.taskGroupId"
                (valueChange)="task.taskGroupId = $event"
                (groupCreated)="onTaskGroupCreated($event)"
                (groupDeleted)="onTaskGroupDeleted($event)"
                placeholder="Seleccionar o crear...">
              </app-task-group-select>
            </div>
          </div>
          
          <!-- Nombre de la tarea con selector de emoji integrado -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la tarea</label>
            <div class="flex gap-2">
              <!-- Selector de emoji compacto -->
              <div class="relative">
                <button 
                  #emojiButton
                  type="button" 
                  (click)="toggleEmojiPicker()" 
                  class="w-12 h-11 flex items-center justify-center bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                  <span class="text-xl">{{task.emoji || ''}}</span>
                </button>
              </div>
              
              <!-- Input del nombre -->
              <div class="flex-1">
                <input 
                  type="text" 
                  [(ngModel)]="task.name" 
                  name="name" 
                  (blur)="onTaskNameBlur()"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                  placeholder="Escribe el nombre de tu tarea..."
                  required>
              </div>
            </div>
          </div>
          
          <!-- Tabs: Descripci贸n / Acciones -->
          <div>
            <!-- Botones de tabs -->
            <div class="flex gap-1 p-1 bg-gray-100 rounded-lg mb-2">
              <button type="button"
                      (click)="activeDetailTab = 'description'"
                      class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2"
                      [class]="activeDetailTab === 'description' 
                        ? 'bg-white text-gray-900 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-900'">
                <i class="fas fa-align-left"></i>
                <span>Descripci贸n</span>
              </button>
              <button type="button"
                      (click)="activeDetailTab = 'actions'"
                      class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2"
                      [class]="activeDetailTab === 'actions' 
                        ? 'bg-white text-purple-700 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-900'">
                <i class="fas fa-list-check"></i>
                <span>Acciones</span>
                <span *ngIf="task.actionsPerformed && task.actionsPerformed.length > 0" 
                      class="bg-purple-100 text-purple-700 text-xs px-1.5 py-0.5 rounded-full">
                  {{ task.actionsPerformed.length }}
                </span>
              </button>
            </div>
            
            <!-- Contenido: Descripci贸n (usando class.hidden en lugar de *ngIf para evitar destrucci贸n/recreaci贸n del DOM) -->
            <div [class.hidden]="activeDetailTab !== 'description'">
              <textarea [(ngModel)]="task.description" name="description" rows="3" 
                        class="w-full px-3 py-2 border rounded-lg text-sm" 
                        placeholder="Describe los detalles de esta tarea..."></textarea>
            </div>
            
            <!-- Contenido: Acciones (usando class.hidden y propiedades pre-calculadas para m谩ximo rendimiento) -->
            <div [class.hidden]="activeDetailTab !== 'actions'" class="bg-purple-50 rounded-lg border border-purple-200 p-3">
              <!-- Header con tiempo restante -->
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-600">Registra lo que hiciste</span>
                <div *ngIf="startTime && endTime" class="text-xs text-purple-700 bg-purple-100 px-2 py-0.5 rounded-full">
                  <i class="fas fa-clock mr-1"></i>{{ remainingMinutes }} min
                </div>
              </div>
              
              <!-- Botones para agregar acciones (usando propiedades pre-calculadas) -->
              <div class="flex gap-2 mb-2">
                <button type="button" 
                        (click)="addAction(5)"
                        [disabled]="!canAdd5"
                        [title]="tooltip5"
                        class="flex-1 px-2 py-1.5 text-xs font-medium rounded-lg transition-colors flex items-center justify-center"
                        [class]="canAdd5 
                          ? 'bg-purple-600 text-white hover:bg-purple-700' 
                          : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                  <i class="fas fa-plus mr-1"></i>5m
                </button>
                <button type="button" 
                        (click)="addAction(10)"
                        [disabled]="!canAdd10"
                        [title]="tooltip10"
                        class="flex-1 px-2 py-1.5 text-xs font-medium rounded-lg transition-colors flex items-center justify-center"
                        [class]="canAdd10 
                          ? 'bg-purple-600 text-white hover:bg-purple-700' 
                          : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                  <i class="fas fa-plus mr-1"></i>10m
                </button>
                <button type="button" 
                        (click)="addAction(15)"
                        [disabled]="!canAdd15"
                        [title]="tooltip15"
                        class="flex-1 px-2 py-1.5 text-xs font-medium rounded-lg transition-colors flex items-center justify-center"
                        [class]="canAdd15 
                          ? 'bg-purple-600 text-white hover:bg-purple-700' 
                          : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                  <i class="fas fa-plus mr-1"></i>15m
                </button>
              </div>
              
              <!-- Lista de acciones (con trackBy para optimizar re-renderizado) -->
              <div *ngIf="task.actionsPerformed && task.actionsPerformed.length > 0" class="space-y-1 max-h-32 overflow-y-auto actions-list">
                <div *ngFor="let action of task.actionsPerformed; let i = index; let isLast = last; trackBy: trackByActionIndex" 
                     class="bg-white rounded border border-purple-200 px-2 py-1 relative action-item"
                     [class.action-item-last]="isLast">
                  <div class="flex items-center gap-2">
                    <div class="flex-shrink-0 bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-xs font-mono font-medium min-w-[85px] text-center">
                      {{ action.startTime }} - {{ action.endTime }}
                    </div>
                    <input type="text"
                           [(ngModel)]="action.description"
                           [name]="'actionDesc' + i"
                           placeholder="驴Qu茅 hiciste?"
                           class="flex-1 px-2 py-1 border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                    <button *ngIf="isLast"
                            type="button"
                            (click)="removeLastAction()"
                            class="flex-shrink-0 w-5 h-5 flex items-center justify-center text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                            title="Eliminar 煤ltima acci贸n">
                      <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Estado vac铆o -->
              <div *ngIf="!task.actionsPerformed || task.actionsPerformed.length === 0" 
                   class="text-center text-gray-500 py-3 bg-white rounded border border-dashed border-purple-200">
                <i class="fas fa-clipboard-list text-xl text-purple-300 mb-1"></i>
                <p class="text-xs">Sin acciones registradas</p>
              </div>
            </div>
          </div>
          <!-- Secci贸n de fechas y horas compacta -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <!-- Fecha y hora de inicio -->
            <div class="bg-blue-50 rounded-lg border border-blue-200 px-2 py-2">
              <div class="flex items-center gap-2">
                <!-- Contenedor cuadrado con icono y texto apilados -->
                <div class="w-12 h-12 bg-blue-500 rounded-lg flex flex-col items-center justify-center flex-shrink-0">
                  <i class="fas fa-play text-white text-sm"></i>
                  <span class="text-[9px] font-medium text-white mt-0.5">Inicio</span>
                </div>
                <div class="flex-1">
                  <app-android-date-picker
                    [(ngModel)]="startDate"
                    (dateChange)="onDateChange('start', $event)"
                    name="startDate"
                    label="Fecha"
                    placeholder="Fecha"
                    [required]="true">
                  </app-android-date-picker>
                </div>
                <div class="flex-1 flex items-center gap-1">
                  <div class="flex-1">
                    <app-mui-time-picker
                      [(ngModel)]="startTime"
                      (timeChange)="onStartTimeChange($event)"
                      name="startTime"
                      label="Hora"
                      placeholder="HH:MM"
                      [referenceTime]="getCurrentTime()"
                      referenceLabel="Hora actual">
                    </app-mui-time-picker>
                  </div>
                  <button type="button" 
                          (click)="openTimeCalculator('start')" 
                          class="w-7 h-7 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors flex items-center justify-center flex-shrink-0"
                          title="Calcular desde hora de fin">
                    <i class="fas fa-calculator text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Fecha y hora de fin -->
            <div class="bg-green-50 rounded-lg border border-green-200 px-2 py-2">
              <div class="flex items-center gap-2">
                <!-- Contenedor cuadrado con icono y texto apilados -->
                <div class="w-12 h-12 bg-green-500 rounded-lg flex flex-col items-center justify-center flex-shrink-0">
                  <i class="fas fa-stop text-white text-sm"></i>
                  <span class="text-[9px] font-medium text-white mt-0.5">Fin</span>
                </div>
                <div class="flex-1">
                  <app-android-date-picker
                    [(ngModel)]="endDate"
                    (dateChange)="onDateChange('end', $event)"
                    name="endDate"
                    label="Fecha"
                    placeholder="Fecha"
                    [required]="true">
                  </app-android-date-picker>
                </div>
                <div class="flex-1 flex items-center gap-1">
                  <div class="flex-1">
                    <app-mui-time-picker
                      [(ngModel)]="endTime"
                      (timeChange)="onEndTimeChange($event)"
                      name="endTime"
                      label="Hora"
                      placeholder="HH:MM"
                      [referenceTimes]="[
                        { time: startTime, label: 'Hora de inicio' },
                        { time: getCurrentTime(), label: 'Hora actual' }
                      ]">
                    </app-mui-time-picker>
                  </div>
                  <button type="button" 
                          (click)="openTimeCalculator('end')" 
                          class="w-7 h-7 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors flex items-center justify-center flex-shrink-0"
                          title="Calcular desde hora de inicio">
                    <i class="fas fa-calculator text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <!-- Fecha l铆mite (toggle + contenido) -->
            <div class="flex items-center gap-2">
              <!-- Bot贸n toggle para fecha l铆mite -->
              <button type="button" 
                      (click)="toggleDeadlineSection()" 
                      class="w-12 h-12 rounded-lg flex flex-col items-center justify-center flex-shrink-0 transition-colors"
                      [class]="showDeadlineSection ? 'bg-orange-500' : 'bg-gray-300 hover:bg-gray-400'">
                <i class="fas fa-flag-checkered text-white text-sm"></i>
                <span class="text-[9px] font-medium text-white mt-0.5">L铆mite</span>
              </button>
              
              <!-- Campos de fecha l铆mite (solo si est谩 activo) -->
              <div *ngIf="showDeadlineSection" class="flex-1 flex items-center gap-2 bg-orange-50 rounded-lg border border-orange-200 px-2 py-1.5">
                <div class="flex-1">
                  <app-android-date-picker
                    [(ngModel)]="deadlineDate"
                    (dateChange)="onDateChange('deadline', $event)"
                    name="deadlineDate"
                    label="Fecha"
                    placeholder="Fecha">
                  </app-android-date-picker>
                </div>
                <div class="flex-1">
                  <app-mui-time-picker
                    [(ngModel)]="deadlineTime"
                    (timeChange)="onDeadlineTimeChange($event)"
                    name="deadlineTime"
                    label="Hora"
                    placeholder="HH:MM">
                  </app-mui-time-picker>
                </div>
              </div>
              
              <!-- Placeholder cuando no hay fecha l铆mite -->
              <div *ngIf="!showDeadlineSection" class="flex-1 text-xs text-gray-400 italic">
                Click para agregar fecha l铆mite
              </div>
            </div>
            
            <!-- Duraci贸n estimada -->
            <div class="flex items-center gap-2">
              <div class="w-12 h-12 bg-indigo-500 rounded-lg flex flex-col items-center justify-center flex-shrink-0">
                <i class="fas fa-hourglass-half text-white text-sm"></i>
                <span class="text-[9px] font-medium text-white mt-0.5">Horas</span>
              </div>
              <div class="flex-1">
                <input type="number" [(ngModel)]="task.duration" (ngModelChange)="onDurationChange($event)" name="duration" min="0" step="0.5" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Duraci贸n">
              </div>
            </div>
          </div>
          
          
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Recordatorios</label>
              
              <!-- Vista no editable de recordatorios -->
              <div class="bg-gray-50 rounded-lg p-4 mb-3">
                <div *ngIf="!task.reminders || task.reminders.length === 0" class="text-center text-gray-500 py-4">
                  <i class="fas fa-bell-slash text-2xl mb-2"></i>
                  <p>No hay recordatorios configurados</p>
                </div>
                
                <div *ngIf="task.reminders && task.reminders.length > 0" class="space-y-4">
                  <!-- Tabla de recordatorios categorizados -->
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    
                    <!-- Antes del inicio -->
                    <div class="bg-white rounded-lg p-3 border">
                      <h4 class="font-medium text-indigo-600 mb-2 text-center">
                        <i class="fas fa-clock mr-1"></i>
                        Antes del Inicio
                      </h4>
                      <div class="space-y-1">
                        <div *ngFor="let item of currentCategorizedReminders.beforeStart" 
                             class="text-xs p-2 bg-indigo-50 rounded border-l-2 border-indigo-300">
                          <div class="font-medium">{{ item.description }}</div>
                          <div class="text-gray-600">{{ formatReminderDateTime(item.reminder) }}</div>
                        </div>
                        <div *ngIf="currentCategorizedReminders.beforeStart.length === 0" 
                             class="text-center text-gray-400 py-2">
                          No hay recordatorios antes del inicio
                        </div>
                      </div>
                    </div>
                    
                    <!-- Durante el evento -->
                    <div class="bg-white rounded-lg p-3 border">
                      <h4 class="font-medium text-green-600 mb-2 text-center">
                        <i class="fas fa-play-circle mr-1"></i>
                        Durante el Evento
                      </h4>
                      <div class="space-y-1">
                        <div *ngFor="let item of currentCategorizedReminders.duringEvent" 
                             class="text-xs p-2 bg-green-50 rounded border-l-2 border-green-300">
                          <div class="font-medium">{{ item.description }}</div>
                          <div class="text-gray-600">{{ formatReminderDateTime(item.reminder) }}</div>
                        </div>
                        <div *ngIf="currentCategorizedReminders.duringEvent.length === 0" 
                             class="text-center text-gray-400 py-2">
                          No hay recordatorios durante el evento
                        </div>
                      </div>
                    </div>
                    
                    <!-- Antes/Despu茅s del l铆mite -->
                    <div class="bg-white rounded-lg p-3 border" *ngIf="getTaskReferenceDates().deadline">
                      <h4 class="font-medium text-amber-600 mb-2 text-center">
                        <i class="fas fa-flag-checkered mr-1"></i>
                        Antes/Despu茅s del L铆mite
                      </h4>
                      <div class="space-y-1">
                        <!-- Recordatorios antes del l铆mite -->
                        <div *ngFor="let item of currentCategorizedReminders.beforeDeadline" 
                             class="text-xs p-2 bg-amber-50 rounded border-l-2 border-amber-300">
                          <div class="font-medium">{{ item.description }}</div>
                          <div class="text-gray-600">{{ formatReminderDateTime(item.reminder) }}</div>
                        </div>
                        <!-- Recordatorios despu茅s del l铆mite -->
                        <div *ngFor="let item of currentCategorizedReminders.afterDeadline" 
                             class="text-xs p-2 bg-red-50 rounded border-l-2 border-red-300">
                          <div class="font-medium">{{ item.description }}</div>
                          <div class="text-gray-600">{{ formatReminderDateTime(item.reminder) }}</div>
                        </div>
                        <div *ngIf="currentCategorizedReminders.beforeDeadline.length === 0 && currentCategorizedReminders.afterDeadline.length === 0" 
                             class="text-center text-gray-400 py-2">
                          No hay recordatorios relacionados con la fecha l铆mite
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Resumen -->
                  <div class="text-center text-gray-600 text-sm">
                    Total: {{ task.reminders.length }} recordatorio{{ task.reminders.length !== 1 ? 's' : '' }}
                  </div>
                </div>
              <!-- Bot贸n para editar recordatorios -->
              <div class="flex justify-end">
                <button type="button" 
                        (click)="prepareTaskDatesForReminders(); openRemindersModal.emit()" 
                        class="w-1/3 px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                  <i class="fas fa-edit mr-2"></i>Editar Recordatorios
                </button>
              </div>
              </div>
              
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fragmentos (Pausas)</label>
              <div #fragmentsContainer class="space-y-2">
                <div *ngFor="let fragment of task.fragments; let i = index" class="fragment-item bg-gray-100 p-3 rounded-lg relative">
                  <button 
                    type="button" 
                    (click)="removeFragment(i)" 
                    class="absolute top-3 right-3 text-red-500 hover:text-red-700 transition-colors p-1 rounded hover:bg-red-50"
                    title="Eliminar fragmento">
                    <i class="fas fa-trash"></i>
                  </button>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Inicio del fragmento -->
                    <div class="bg-blue-50 rounded-lg border border-blue-200 p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                          <i class="fas fa-play text-white text-xs"></i>
                        </div>
                        <label class="text-xs font-medium text-gray-700">Inicio</label>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 pl-10">
                        <div>
                          <label class="block text-xs text-gray-500 mb-1">FECHA</label>
                          <app-android-date-picker
                            [ngModel]="getFragmentStartDate(i)"
                            (dateChange)="onFragmentStartDateChange(i, $event)"
                            [name]="'fragmentStartDate' + i"
                            label="Fecha de inicio"
                            placeholder="Seleccionar fecha"
                            [required]="true">
                          </app-android-date-picker>
                        </div>
                        <div>
                          <label class="block text-xs text-gray-500 mb-1">HORA</label>
                          <app-mui-time-picker
                            [ngModel]="getFragmentStartTime(i)"
                            (timeChange)="onFragmentStartTimeChange(i, $event)"
                            [name]="'fragmentStartTime' + i"
                            label="Hora de inicio"
                            placeholder="HH:MM">
                          </app-mui-time-picker>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Fin del fragmento -->
                    <div class="bg-green-50 rounded-lg border border-green-200 p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-2">
                          <i class="fas fa-stop text-white text-xs"></i>
                        </div>
                        <label class="text-xs font-medium text-gray-700">Fin</label>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 pl-10">
                        <div>
                          <label class="block text-xs text-gray-500 mb-1">FECHA</label>
                          <app-android-date-picker
                            [ngModel]="getFragmentEndDate(i)"
                            (dateChange)="onFragmentEndDateChange(i, $event)"
                            [name]="'fragmentEndDate' + i"
                            label="Fecha de fin"
                            placeholder="Seleccionar fecha"
                            [required]="true">
                          </app-android-date-picker>
                        </div>
                        <div>
                          <label class="block text-xs text-gray-500 mb-1">HORA</label>
                          <app-mui-time-picker
                            [ngModel]="getFragmentEndTime(i)"
                            (timeChange)="onFragmentEndTimeChange(i, $event)"
                            [name]="'fragmentEndTime' + i"
                            label="Hora de fin"
                            placeholder="HH:MM">
                          </app-mui-time-picker>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" (click)="addFragment()" class="mt-2 px-3 py-1 bg-gray-200 rounded-lg text-sm">
                <i class="fas fa-plus mr-1"></i> Agregar fragmento
              </button>
              <!-- Mostrar suma de duraciones de fragmentos -->
              <div *ngIf="task.fragments && task.fragments.length > 0" class="mt-3 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-indigo-700">
                    <i class="fas fa-clock mr-2"></i>Duraci贸n total de fragmentos:
                  </span>
                  <span class="text-sm font-bold text-indigo-900">
                    {{ formatTotalFragmentsDuration() }}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mensaje de error para validaci贸n de fechas -->
          <div *ngIf="dateError" class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
            <div class="flex items-center">
              <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
              <span class="text-red-600 text-sm font-medium">{{ dateError }}</span>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Botones fijos al final -->
    <div *ngIf="!isLoading" class="p-4 md:p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0">
      <div class="flex justify-end space-x-3">
        <button type="button" 
                (click)="closeModal()" 
                [disabled]="isSaving"
                [class.opacity-50]="isSaving"
                [class.cursor-not-allowed]="isSaving"
                class="px-4 py-2 border rounded-lg font-medium">
          Cancelar
        </button>
        <button type="submit" 
                [attr.form]="formId"
                [disabled]="!isFormValid() || isSaving" 
                [class.opacity-50]="!isFormValid() || isSaving"
                [class.cursor-not-allowed]="!isFormValid() || isSaving"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 disabled:hover:bg-indigo-600 flex items-center justify-center gap-2">
          <span *ngIf="isSaving" class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></span>
          <span>{{ isSaving ? 'Guardando...' : (isEditing ? 'Guardar Cambios' : 'Guardar Tarea') }}</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmaci贸n para mantener duraci贸n -->
<div *ngIf="showDurationConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
        <i class="fas fa-clock text-blue-600 text-xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900">驴Mantener duraci贸n de la tarea?</h3>
    </div>
    
    <div class="mb-6">
      <p class="text-gray-600 mb-3">
        Has modificado la fecha/hora de inicio. La duraci贸n actual de la tarea es de 
        <span class="font-semibold text-indigo-600">{{ formatDuration(task.duration || 0) }}</span>.
      </p>
      <p class="text-gray-600">
        驴Deseas ajustar autom谩ticamente la fecha/hora de fin para mantener esta duraci贸n?
      </p>
      <div *ngIf="task.reminders && task.reminders.length > 0" class="mt-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
        <p class="text-amber-800 text-sm">
          <i class="fas fa-bell mr-1"></i>
          <strong>Nota:</strong> Los {{ task.reminders.length }} recordatorio{{ task.reminders.length !== 1 ? 's' : '' }} 
          configurados se ajustar谩n autom谩ticamente con el cambio de fecha/hora de inicio.
        </p>
      </div>
    </div>
    
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Nueva fecha/hora de inicio:</span>
          <span class="font-medium">{{ formatDateTime(pendingStartDate, pendingStartTime) }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Fecha/hora de fin actual:</span>
          <span class="font-medium">{{ formatDateTime(endDate, endTime) }}</span>
        </div>
        <div class="flex justify-between text-indigo-600">
          <span>Nueva fecha/hora de fin (si mantiene duraci贸n):</span>
          <span class="font-medium">{{ formatDateTime(calculatedEndDate, calculatedEndTime) }}</span>
        </div>
      </div>
    </div>
    
    <div class="flex justify-end space-x-3">
      <button type="button" 
              (click)="cancelDurationAdjustment()" 
              class="px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors">
        No, mantener fecha de fin actual
      </button>
      <button type="button" 
              (click)="confirmDurationAdjustment()" 
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
        S铆, ajustar fecha de fin
      </button>
    </div>
  </div>
</div>

<!-- Modal de confirmaci贸n para mantener duraci贸n de fragmento -->
<div *ngIf="showFragmentDurationConfirmModal && pendingFragmentIndex !== null" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
        <i class="fas fa-clock text-blue-600 text-xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900">驴Mantener duraci贸n del fragmento?</h3>
    </div>
    
    <div class="mb-6">
      <p class="text-gray-600 mb-3">
        Has modificado la fecha/hora de inicio del fragmento. La duraci贸n actual del fragmento es de 
        <span class="font-semibold text-indigo-600">{{ formatDuration(calculateFragmentDuration(pendingFragmentIndex)) }}</span>.
      </p>
      <p class="text-gray-600">
        驴Deseas ajustar autom谩ticamente la fecha/hora de fin para mantener esta duraci贸n?
      </p>
    </div>
    
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Nueva fecha/hora de inicio:</span>
          <span class="font-medium">{{ formatDateTime(pendingFragmentStartDate, pendingFragmentStartTime) }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Fecha/hora de fin actual:</span>
          <span class="font-medium">{{ formatDateTime(getFragmentEndDate(pendingFragmentIndex), getFragmentEndTime(pendingFragmentIndex)) }}</span>
        </div>
        <div class="flex justify-between text-indigo-600">
          <span>Nueva fecha/hora de fin (si mantiene duraci贸n):</span>
          <span class="font-medium">{{ formatDateTime(calculatedFragmentEndDate, calculatedFragmentEndTime) }}</span>
        </div>
      </div>
    </div>
    
    <div class="flex justify-end space-x-3">
      <button type="button" 
              (click)="cancelFragmentDurationAdjustment()" 
              class="px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors">
        No, mantener fecha de fin actual
      </button>
      <button type="button" 
              (click)="confirmFragmentDurationAdjustment()" 
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
        S铆, ajustar fecha de fin
      </button>
    </div>
  </div>
</div>

<!-- Modal de confirmaci贸n para actualizar duraci贸n desde tarea reciente/autocompletado -->
<div *ngIf="showUpdateDurationFromTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4" style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4">
        <i class="fas fa-clock text-purple-600 text-xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900">驴Actualizar duraci贸n de la tarea?</h3>
    </div>
    
    <div class="mb-6">
      <p class="text-gray-600 mb-3">
        <span *ngIf="updateDurationSource === 'recent'">La tarea seleccionada</span>
        <span *ngIf="updateDurationSource === 'autocomplete'">La tarea autocompletada</span>
        tiene una duraci贸n de 
        <span class="font-semibold text-purple-600">{{ formatDuration(pendingTaskDuration || 0) }}</span>, 
        pero tu tarea actual tiene una duraci贸n de 
        <span class="font-semibold text-indigo-600">{{ formatDuration(task.duration || 0) }}</span>.
      </p>
      <p class="text-gray-600">
        驴Deseas actualizar la duraci贸n a la de la tarea 
        <span *ngIf="updateDurationSource === 'recent'">seleccionada</span>
        <span *ngIf="updateDurationSource === 'autocomplete'">autocompletada</span>?
      </p>
    </div>
    
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Duraci贸n actual:</span>
          <span class="font-medium text-indigo-600">{{ formatDuration(task.duration || 0) }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Nueva duraci贸n:</span>
          <span class="font-medium text-purple-600">{{ formatDuration(pendingTaskDuration || 0) }}</span>
        </div>
      </div>
    </div>
    
    <div class="flex justify-end space-x-3">
      <button type="button" 
              (click)="cancelUpdateDurationFromTask()" 
              class="px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors">
        No, mantener duraci贸n actual
      </button>
      <button type="button" 
              (click)="confirmUpdateDurationFromTask()" 
              class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors">
        S铆, actualizar duraci贸n
      </button>
    </div>
  </div>
</div>

<!-- Modal secundario para tareas recientes -->
<div *ngIf="showRecentTasksModal && showRecentTasksSelector && recentTasks.length > 0 && !isEditing" 
     class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4"
     (click)="closeRecentTasksModal()"
     style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col"
       (click)="$event.stopPropagation()"
       style="overflow-y: auto;">
    <!-- Header del modal -->
    <div class="p-4 md:p-6 border-b border-gray-200 flex-shrink-0 bg-indigo-50">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold text-indigo-900 flex items-center">
          <i class="fas fa-history mr-2"></i>
          Tareas Recientes
        </h3>
        <button (click)="closeRecentTasksModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <p class="text-xs text-indigo-700 mt-2">
        <i class="fas fa-info-circle mr-1"></i>
        Selecciona una tarea para copiar autom谩ticamente: nombre, tipo, emoji, descripci贸n, prioridad y duraci贸n
      </p>
    </div>
    
    <!-- Contenido scrollable -->
    <div class="flex-1 overflow-y-auto p-4 md:p-6">
      <!-- Grupos de tareas (tareas con nombre repetido) -->
      <div *ngIf="multipleTaskGroups.length > 0" class="mb-4">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2">
          <i class="fas fa-layer-group"></i>
          Tareas agrupadas ({{ multipleTaskGroups.length }})
        </div>
        <div class="space-y-2">
          <div *ngFor="let group of multipleTaskGroups" class="border border-gray-200 rounded-lg overflow-hidden">
            <!-- Header del grupo (clickeable para expandir/colapsar, click derecho para men煤) -->
            <div (click)="toggleTaskGroup(group.name)"
                 (contextmenu)="onGroupContextMenu($event, group.name)"
                 (touchstart)="onGroupTouchStart($event, group.name)"
                 (touchend)="onGroupTouchEnd()"
                 (touchmove)="onGroupTouchMove()"
                 class="p-3 bg-gray-50 hover:bg-gray-100 cursor-pointer flex items-center gap-3 transition-colors">
              <span class="text-2xl flex-shrink-0">{{ group.emoji }}</span>
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-gray-900 truncate">{{ group.name }}</h4>
                <span class="text-xs text-gray-500">{{ group.tasks.length }} tareas</span>
              </div>
              <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"
                 [class.rotate-180]="isTaskGroupExpanded(group.name)"></i>
            </div>
            
            <!-- Tareas del grupo (expandibles) -->
            <div *ngIf="isTaskGroupExpanded(group.name)" class="border-t border-gray-200 bg-white">
              <div *ngFor="let item of group.tasks; let isLast = last"
                   (click)="editingTaskIndex !== item.originalIndex && applyRecentTaskData(item.originalIndex); $event.stopPropagation()"
                   (contextmenu)="onRecentTaskContextMenu($event, item.originalIndex)"
                   (touchstart)="onRecentTaskTouchStart($event, item.originalIndex)"
                   (touchend)="onRecentTaskTouchEnd()"
                   (touchmove)="onRecentTaskTouchMove()"
                   class="p-3 pl-6 hover:bg-indigo-50 cursor-pointer transition-colors"
                   [class.border-b]="!isLast"
                   [class.border-gray-100]="!isLast"
                   [class.ring-2]="editingTaskIndex === item.originalIndex"
                   [class.ring-indigo-500]="editingTaskIndex === item.originalIndex"
                   [class.ring-inset]="editingTaskIndex === item.originalIndex">
                <div class="flex items-start gap-3">
                  <!-- Emoji - editable -->
                  <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'emoji'; else groupNormalEmoji">
                    <button type="button" 
                            (click)="showEmojiPickerForEdit = true; $event.stopPropagation()"
                            class="text-xl flex-shrink-0 p-1 rounded hover:bg-indigo-100 border-2 border-indigo-400">
                      {{ editingValue || '' }}
                    </button>
                  </ng-container>
                  <ng-template #groupNormalEmoji>
                    <span class="text-xl flex-shrink-0 opacity-50">{{ item.task.emoji || '' }}</span>
                  </ng-template>
                  
                  <div class="flex-1 min-w-0">
                    <!-- Nombre - editable -->
                    <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'name'; else groupNormalName">
                      <div class="flex items-center gap-2">
                        <input type="text"
                               id="edit-task-name-input"
                               [(ngModel)]="editingValue"
                               (keydown)="onEditNameKeydown($event)"
                               (blur)="saveQuickEdit()"
                               (click)="$event.stopPropagation()"
                               class="flex-1 px-2 py-1 text-sm border border-indigo-400 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Nombre de la tarea">
                        <button type="button" 
                                (click)="saveQuickEdit(); $event.stopPropagation()"
                                class="p-1 text-green-600 hover:bg-green-100 rounded"
                                [disabled]="isSavingQuickEdit">
                          <i class="fas fa-check"></i>
                        </button>
                        <button type="button" 
                                (click)="cancelQuickEdit(); $event.stopPropagation()"
                                class="p-1 text-gray-500 hover:bg-gray-100 rounded">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </ng-container>
                    <ng-template #groupNormalName>
                      <!-- Mostrar solo la fecha como t铆tulo ya que el nombre es el del grupo -->
                      <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-600">
                        <span *ngIf="item.task.start" class="flex items-center">
                          <i class="fas fa-play text-green-500 mr-1"></i>
                          {{ formatRecentTaskDate(item.task.start) }}
                        </span>
                        <span *ngIf="item.task.end" class="flex items-center">
                          <i class="fas fa-stop text-red-500 mr-1"></i>
                          {{ formatRecentTaskDate(item.task.end) }}
                        </span>
                        <span *ngIf="item.task.duration" class="flex items-center font-medium text-indigo-600">
                          <i class="fas fa-clock mr-1"></i>
                          {{ formatDuration(item.task.duration) }}
                        </span>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tareas unitarias (nombre 煤nico) -->
      <div *ngIf="singleTasks.length > 0">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2">
          <i class="fas fa-tasks"></i>
          Tareas individuales ({{ singleTasks.length }})
        </div>
        <div class="space-y-2">
          <div *ngFor="let item of singleTasks" 
               (click)="editingTaskIndex !== item.originalIndex && applyRecentTaskData(item.originalIndex)"
               (contextmenu)="onRecentTaskContextMenu($event, item.originalIndex)"
               (touchstart)="onRecentTaskTouchStart($event, item.originalIndex)"
               (touchend)="onRecentTaskTouchEnd()"
               (touchmove)="onRecentTaskTouchMove()"
               class="p-3 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-colors"
               [class.ring-2]="editingTaskIndex === item.originalIndex"
               [class.ring-indigo-500]="editingTaskIndex === item.originalIndex">
            <div class="flex items-start gap-3">
              <!-- Emoji - editable -->
              <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'emoji'; else singleNormalEmoji">
                <button type="button" 
                        (click)="showEmojiPickerForEdit = true; $event.stopPropagation()"
                        class="text-2xl flex-shrink-0 p-1 rounded hover:bg-indigo-100 border-2 border-indigo-400">
                  {{ editingValue || '' }}
                </button>
              </ng-container>
              <ng-template #singleNormalEmoji>
                <span class="text-2xl flex-shrink-0">{{ item.task.emoji || '' }}</span>
              </ng-template>
              
              <div class="flex-1 min-w-0">
                <!-- Nombre - editable -->
                <ng-container *ngIf="editingTaskIndex === item.originalIndex && editingField === 'name'; else singleNormalName">
                  <div class="flex items-center gap-2">
                    <input type="text"
                           id="edit-task-name-input"
                           [(ngModel)]="editingValue"
                           (keydown)="onEditNameKeydown($event)"
                           (blur)="saveQuickEdit()"
                           (click)="$event.stopPropagation()"
                           class="flex-1 px-2 py-1 text-sm border border-indigo-400 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Nombre de la tarea">
                    <button type="button" 
                            (click)="saveQuickEdit(); $event.stopPropagation()"
                            class="p-1 text-green-600 hover:bg-green-100 rounded"
                            [disabled]="isSavingQuickEdit">
                      <i class="fas fa-check"></i>
                    </button>
                    <button type="button" 
                            (click)="cancelQuickEdit(); $event.stopPropagation()"
                            class="p-1 text-gray-500 hover:bg-gray-100 rounded">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </ng-container>
                <ng-template #singleNormalName>
                  <h4 class="font-medium text-gray-900 truncate">{{ item.task.name }}</h4>
                </ng-template>
                
                <!-- Fechas de inicio y fin -->
                <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-500 mt-1">
                  <span *ngIf="item.task.start" class="flex items-center">
                    <i class="fas fa-play text-green-500 mr-1"></i>
                    {{ formatRecentTaskDate(item.task.start) }}
                  </span>
                  <span *ngIf="item.task.end" class="flex items-center">
                    <i class="fas fa-stop text-red-500 mr-1"></i>
                    {{ formatRecentTaskDate(item.task.end) }}
                  </span>
                  <span *ngIf="item.task.duration" class="flex items-center font-medium text-indigo-600">
                    <i class="fas fa-clock mr-1"></i>
                    {{ formatDuration(item.task.duration) }}
                  </span>
                </div>
                <div *ngIf="item.task.description" class="text-xs text-gray-600 mt-1 line-clamp-2">
                  {{ item.task.description }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mensaje cuando no hay tareas -->
      <div *ngIf="recentTasks.length === 0" class="text-center text-gray-500 py-8">
        <i class="fas fa-inbox text-3xl mb-2 text-gray-300"></i>
        <p>No hay tareas recientes en este proyecto</p>
      </div>
    </div>
  </div>
</div>

<!-- Men煤 contextual para tareas recientes -->
<div *ngIf="showContextMenu" 
     class="fixed z-[100] bg-white rounded-lg shadow-xl border border-gray-200 py-1 min-w-[160px]"
     [style.left.px]="contextMenuX"
     [style.top.px]="contextMenuY"
     (click)="$event.stopPropagation()">
  <button type="button"
          (click)="startEditEmoji()"
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
    <i class="fas fa-smile text-indigo-500"></i>
    Editar emoji
  </button>
  <button type="button"
          (click)="startEditName()"
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
    <i class="fas fa-edit text-indigo-500"></i>
    Editar nombre
  </button>
</div>

<!-- Overlay para cerrar men煤 contextual -->
<div *ngIf="showContextMenu" 
     class="fixed inset-0 z-[99]"
     (click)="closeContextMenu()">
</div>

<!-- Men煤 contextual para grupos de tareas -->
<div *ngIf="showGroupContextMenu" 
     class="fixed z-[100] bg-white rounded-lg shadow-xl border border-gray-200 py-1 min-w-[200px]"
     [style.left.px]="groupContextMenuX"
     [style.top.px]="groupContextMenuY"
     (click)="$event.stopPropagation()">
  <button type="button"
          (click)="startEditGroupEmoji()"
          class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
    <i class="fas fa-smile text-indigo-500"></i>
    Cambiar emoji a todas
  </button>
</div>

<!-- Overlay para cerrar men煤 contextual de grupo -->
<div *ngIf="showGroupContextMenu" 
     class="fixed inset-0 z-[99]"
     (click)="closeGroupContextMenu()">
</div>

<!-- Modal de emoji picker para grupos -->
<div *ngIf="showEmojiPickerForGroup" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] p-4"
     (click)="closeEmojiPickerForGroup()">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden flex flex-col"
       style="height: 500px;"
       (click)="$event.stopPropagation()">
    <!-- Header con b煤squeda (altura fija) -->
    <div class="p-4 border-b border-gray-200 flex-shrink-0">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-gray-900">
          <i class="fas fa-layer-group mr-2 text-indigo-500"></i>
          Emoji para el grupo
        </h3>
        <button type="button" 
                (click)="closeEmojiPickerForGroup()"
                class="text-gray-500 hover:text-gray-700 p-1">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <p class="text-xs text-gray-500 mb-3">
        <i class="fas fa-info-circle mr-1"></i>
        Se aplicar谩 a todas las tareas del grupo "{{ contextMenuGroupName }}"
      </p>
      <!-- Barra de b煤squeda -->
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <input type="text"
               [ngModel]="editEmojiSearchQuery"
               (ngModelChange)="onEditEmojiSearch($event)"
               placeholder="Buscar emoji... (ej: enojado, angry, feliz, happy)"
               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        <button *ngIf="editEmojiSearchQuery" 
                type="button"
                (click)="onEditEmojiSearch('')"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
          <i class="fas fa-times-circle"></i>
        </button>
      </div>
    </div>
    
    <!-- Barra de categor铆as (altura fija, siempre visible) -->
    <div class="flex overflow-x-auto border-b border-gray-200 bg-gray-50 px-2 py-1 flex-shrink-0"
         [class.opacity-50]="editEmojiSearchQuery"
         [class.pointer-events-none]="editEmojiSearchQuery">
      <button *ngFor="let category of emojiCategories; let i = index"
              type="button"
              (click)="selectEditEmojiCategory(i)"
              [class.bg-indigo-100]="editSelectedEmojiCategory === i && !editEmojiSearchQuery"
              [class.text-indigo-700]="editSelectedEmojiCategory === i && !editEmojiSearchQuery"
              class="flex-shrink-0 px-3 py-2 text-lg rounded-lg hover:bg-gray-200 transition-colors"
              [title]="category.name">
        {{ category.icon }}
      </button>
    </div>
    
    <!-- Contenido de emojis (altura flexible) -->
    <div class="flex-1 overflow-y-auto p-4">
      <!-- Resultados de b煤squeda -->
      <ng-container *ngIf="editEmojiSearchQuery">
        <div *ngIf="editFilteredEmojis.length === 0" class="text-center text-gray-500 py-8">
          <i class="fas fa-search text-3xl mb-2 text-gray-300"></i>
          <p>No se encontraron emojis para "{{ editEmojiSearchQuery }}"</p>
          <p class="text-xs mt-1">Intenta con: enojado, angry, feliz, happy, triste, sad</p>
        </div>
        <div *ngIf="editFilteredEmojis.length > 0" class="grid grid-cols-8 gap-1">
          <button *ngFor="let emoji of editFilteredEmojis"
                  type="button"
                  (click)="selectEmojiForGroup(emoji)"
                  [class.ring-2]="editingValue === emoji"
                  [class.ring-indigo-500]="editingValue === emoji"
                  [disabled]="isSavingGroupEmoji"
                  class="text-2xl p-2 hover:bg-indigo-100 rounded-lg transition-colors disabled:opacity-50">
            {{ emoji }}
          </button>
        </div>
      </ng-container>
      
      <!-- Grid de categor铆a seleccionada -->
      <ng-container *ngIf="!editEmojiSearchQuery">
        <div class="mb-2 text-sm font-medium text-gray-600">
          {{ emojiCategories[editSelectedEmojiCategory].name }}
        </div>
        <div class="grid grid-cols-8 gap-1">
          <button *ngFor="let emoji of emojiCategories[editSelectedEmojiCategory].emojis"
                  type="button"
                  (click)="selectEmojiForGroup(emoji)"
                  [class.ring-2]="editingValue === emoji"
                  [class.ring-indigo-500]="editingValue === emoji"
                  [disabled]="isSavingGroupEmoji"
                  class="text-2xl p-2 hover:bg-indigo-100 rounded-lg transition-colors disabled:opacity-50">
            {{ emoji }}
          </button>
        </div>
      </ng-container>
    </div>
    
    <!-- Footer con indicador de guardado -->
    <div class="p-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Actual:</span>
        <span class="text-3xl">{{ editingValue || '' }}</span>
      </div>
      <div *ngIf="isSavingGroupEmoji" class="flex items-center gap-2 text-indigo-600">
        <i class="fas fa-spinner fa-spin"></i>
        <span class="text-sm">Guardando...</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal de emoji picker para edici贸n r谩pida -->
<div *ngIf="showEmojiPickerForEdit" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] p-4"
     (click)="closeEmojiPickerForEdit()">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden flex flex-col"
       style="height: 500px;"
       (click)="$event.stopPropagation()">
    <!-- Header con b煤squeda (altura fija) -->
    <div class="p-4 border-b border-gray-200 flex-shrink-0">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-gray-900">Seleccionar Emoji</h3>
        <button type="button" 
                (click)="closeEmojiPickerForEdit()"
                class="text-gray-500 hover:text-gray-700 p-1">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <!-- Barra de b煤squeda -->
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <input type="text"
               [ngModel]="editEmojiSearchQuery"
               (ngModelChange)="onEditEmojiSearch($event)"
               placeholder="Buscar emoji... (ej: enojado, angry, feliz, happy)"
               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        <button *ngIf="editEmojiSearchQuery" 
                type="button"
                (click)="onEditEmojiSearch('')"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
          <i class="fas fa-times-circle"></i>
        </button>
      </div>
    </div>
    
    <!-- Barra de categor铆as (altura fija, siempre visible) -->
    <div class="flex overflow-x-auto border-b border-gray-200 bg-gray-50 px-2 py-1 flex-shrink-0"
         [class.opacity-50]="editEmojiSearchQuery"
         [class.pointer-events-none]="editEmojiSearchQuery">
      <button *ngFor="let category of emojiCategories; let i = index"
              type="button"
              (click)="selectEditEmojiCategory(i)"
              [class.bg-indigo-100]="editSelectedEmojiCategory === i && !editEmojiSearchQuery"
              [class.text-indigo-700]="editSelectedEmojiCategory === i && !editEmojiSearchQuery"
              class="flex-shrink-0 px-3 py-2 text-lg rounded-lg hover:bg-gray-200 transition-colors"
              [title]="category.name">
        {{ category.icon }}
      </button>
    </div>
    
    <!-- Contenido de emojis (altura flexible) -->
    <div class="flex-1 overflow-y-auto p-4">
      <!-- Resultados de b煤squeda -->
      <ng-container *ngIf="editEmojiSearchQuery">
        <div *ngIf="editFilteredEmojis.length === 0" class="text-center text-gray-500 py-8">
          <i class="fas fa-search text-3xl mb-2 text-gray-300"></i>
          <p>No se encontraron emojis para "{{ editEmojiSearchQuery }}"</p>
          <p class="text-xs mt-1">Intenta con: enojado, angry, feliz, happy, triste, sad</p>
        </div>
        <div *ngIf="editFilteredEmojis.length > 0" class="grid grid-cols-8 gap-1">
          <button *ngFor="let emoji of editFilteredEmojis"
                  type="button"
                  (click)="selectEmojiForEdit(emoji)"
                  [class.ring-2]="editingValue === emoji"
                  [class.ring-indigo-500]="editingValue === emoji"
                  class="text-2xl p-2 hover:bg-indigo-100 rounded-lg transition-colors">
            {{ emoji }}
          </button>
        </div>
      </ng-container>
      
      <!-- Grid de categor铆a seleccionada -->
      <ng-container *ngIf="!editEmojiSearchQuery">
        <div class="mb-2 text-sm font-medium text-gray-600">
          {{ emojiCategories[editSelectedEmojiCategory].name }}
        </div>
        <div class="grid grid-cols-8 gap-1">
          <button *ngFor="let emoji of emojiCategories[editSelectedEmojiCategory].emojis"
                  type="button"
                  (click)="selectEmojiForEdit(emoji)"
                  [class.ring-2]="editingValue === emoji"
                  [class.ring-indigo-500]="editingValue === emoji"
                  class="text-2xl p-2 hover:bg-indigo-100 rounded-lg transition-colors">
            {{ emoji }}
          </button>
        </div>
      </ng-container>
    </div>
    
    <!-- Footer con emoji seleccionado (altura fija) -->
    <div class="p-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Seleccionado:</span>
        <span class="text-3xl">{{ editingValue || '' }}</span>
      </div>
      <button type="button"
              (click)="selectEmojiForEdit(editingValue)"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium">
        Confirmar
      </button>
    </div>
  </div>
</div>
