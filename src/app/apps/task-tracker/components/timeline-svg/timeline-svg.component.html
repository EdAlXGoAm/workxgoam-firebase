<div #containerRef class="timeline-container w-full overflow-x-auto relative">
  <!-- Controles de Navegación de Fechas -->
  <div class="date-navigation mb-4 flex items-center justify-center bg-white rounded-lg p-3 shadow-sm border gap-2">
    <!-- Badge del día de la semana (ancho fijo) -->
    <div class="w-24 flex-shrink-0 text-center">
      <span class="inline-block px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-semibold capitalize">
        {{ getWeekdayName() }}
      </span>
    </div>
    
    <!-- Flecha izquierda -->
    <button (click)="goToPreviousDay()" 
            class="nav-btn flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
            title="Día anterior">
      <i class="fas fa-chevron-left text-sm text-gray-600"></i>
    </button>
    
    <!-- Selector de fecha -->
    <div class="w-40 flex-shrink-0">
      <app-android-date-picker
        [ngModel]="getDateInputValue()"
        (dateChange)="onDateChange($event)"
        label=""
        placeholder="Seleccionar fecha"
        class="date-picker">
      </app-android-date-picker>
    </div>
    
    <!-- Flecha derecha -->
    <button (click)="goToNextDay()" 
            class="nav-btn flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
            title="Día siguiente">
      <i class="fas fa-chevron-right text-sm text-gray-600"></i>
    </button>
    
    <!-- Botón Hoy -->
    <button (click)="goToToday()" 
            [class.bg-indigo-100]="isToday()"
            [class.text-indigo-700]="isToday()"
            [class.bg-gray-100]="!isToday()"
            [class.text-gray-700]="!isToday()"
            class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-indigo-50 transition-colors flex-shrink-0 ml-1"
            title="Ir a hoy">
      Hoy
    </button>
  </div>

  <!-- Tooltip para mostrar información completa de la tarea -->
  <div *ngIf="showTooltip && tooltipTask" 
       class="tooltip-container absolute -top-[5px] left-1/2 transform -translate-x-1/2 z-50 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl max-w-md"
       (mousedown)="onTooltipMouseDown($event)"
       (mouseup)="onTooltipMouseUp($event)">
    <div class="flex items-center space-x-2">
      <span class="text-lg">{{ tooltipTask.emoji }}</span>
      <div *ngIf="getTaskTypeColor(tooltipTask)" 
           class="w-3 h-3 rounded-full border-2 border-white shadow-sm flex-shrink-0" 
           [style.background-color]="getTaskTypeColor(tooltipTask)"></div>
      <div class="flex-1">
        <div class="font-semibold text-sm">{{ getTaskDisplayName(tooltipTask) }}</div>
        <div *ngIf="taskHasComplexGroup(tooltipTask)" class="text-xs text-amber-300 mt-1 flex items-center space-x-1">
          <i class="fas fa-layer-group text-xs"></i>
          <span class="font-medium">{{ getTaskGroupName(tooltipTask.taskGroupId) }}</span>
        </div>
        <div *ngIf="tooltipTask.description" class="text-xs text-gray-300 mt-1 task-description-clamp">{{ tooltipTask.description }}</div>
        <div class="text-xs text-gray-400 mt-1">
          {{ formatTaskTime(tooltipTask.start) }} - {{ formatTaskTime(tooltipTask.end) }}
        </div>
        <!-- Duración de la tarea -->
        <div *ngIf="getTaskDuration(tooltipTask)" class="text-xs text-purple-300 mt-1 flex items-center space-x-1">
          <i class="fas fa-hourglass-half text-xs"></i>
          <span>Duración: {{ formatTaskDuration(getTaskDuration(tooltipTask)) }}</span>
        </div>
        <!-- Info de tarea compleja -->
        <div *ngIf="taskHasComplexGroup(tooltipTask) && getComplexGroupTotalDuration(tooltipTask)" 
             class="mt-2 pt-2 border-t border-gray-700">
          <div class="text-xs text-amber-300 flex items-center space-x-1">
            <i class="fas fa-layer-group text-xs"></i>
            <span class="font-medium">{{ getTaskGroupName(tooltipTask.taskGroupId) }}</span>
          </div>
          <div class="text-xs text-amber-200 flex items-center space-x-1 mt-1">
            <i class="fas fa-calculator text-xs"></i>
            <span>Total grupo: {{ formatTaskDuration(getComplexGroupTotalDuration(tooltipTask)) }} ({{ getComplexGroupTaskCount(tooltipTask) }} tareas)</span>
          </div>
        </div>
        <!-- Información del tiempo hasta la próxima tarea -->
        <div class="text-xs text-blue-300 mt-2 flex items-center space-x-1">
          <i class="fas fa-clock text-xs"></i>
          <span>{{ getTimeUntilNextTask(tooltipTask) }}</span>
        </div>
      </div>
    </div>
    <!-- Flecha del tooltip -->
    <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-gray-900"></div>
  </div>

  <!-- Contenedor centrado para el SVG -->
  <div class="svg-container flex justify-center overflow-x-auto">
    <svg [attr.width]="svgWidth" [attr.height]="svgHeight" [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight" 
         class="timeline-svg" [style.min-width.px]="minSvgWidth"
         (mousedown)="onSvgMouseDown($event)">
      <!-- Tercio 1: 00:00 - 08:00 -->
      <g transform="translate(0, 0)">
        <rect x="0" y="0" [attr.width]="svgWidth" [attr.height]="sectionHeight" fill="#f0f4f8" rx="6" ry="6"/>
        <line x1="0" y1="40" [attr.x2]="svgWidth" y2="40" stroke="#888" stroke-width="1.5" />
        <text x="10" y="15" [attr.font-size]="titleFontSize" fill="#333" font-weight="bold">00:00 - 08:00</text>
        <g *ngFor="let hour of hoursPerSection[0]">
          <line [attr.x1]="getX(hour, 0)" y1="30" [attr.x2]="getX(hour, 0)" y2="50" stroke="#bbb" stroke-width="1" />
          <text [attr.x]="getX(hour, 0)" y="65" [attr.font-size]="hourFontSize" text-anchor="middle" fill="#666">{{ hour }}:00</text>
        </g>
        <g *ngFor="let item of getRenderableItemsForSection(0); trackBy: trackByRenderableItem"
           [class.task-overdue]="isTaskOverdue(item.task)"
           [class.task-running]="isTaskRunning(item.task)"
           [class.task-hidden]="shouldShowAsHidden(item)"
           [class.task-overlapping]="hasIntersection(item, 0)"
           class="task-group">
          <!-- Borde negro exterior -->
          <rect #taskRect
                [attr.x]="getItemX(item, 0)" y="20" [attr.width]="getItemWidth(item, 0)" height="40"
                [attr.fill]="getTaskColor(item.task)" rx="6" ry="6" 
                [attr.fill-opacity]="getItemOpacity(item, 0)" 
                stroke="rgba(0,0,0,0.6)" stroke-width="1.5" 
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="0"
                class="task-rect" />
          <!-- Borde blanco interior -->
          <rect [attr.x]="getItemX(item, 0)" y="20" [attr.width]="getItemWidth(item, 0)" height="40"
                fill="none" rx="6" ry="6" 
                stroke="rgba(255,255,255,0.8)" stroke-width="1" 
                class="task-inner"
                [attr.data-task-id]="item.task.id" />
          <!-- Handle izquierdo (resize inicio) -->
          <rect #resizeHandleStart
                [attr.x]="getItemX(item, 0)" y="24" width="6" height="32"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-left"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="0" />
          <line [attr.x1]="getItemX(item, 0) + 3" y1="32" [attr.x2]="getItemX(item, 0) + 3" y2="48"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          <!-- Handle derecho (resize fin) -->
          <rect #resizeHandleEnd
                [attr.x]="getItemX(item, 0) + getItemWidth(item, 0) - 6" y="24" width="6" height="32"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-right"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="0" />
          <line [attr.x1]="getItemX(item, 0) + getItemWidth(item, 0) - 3" y1="32" [attr.x2]="getItemX(item, 0) + getItemWidth(item, 0) - 3" y2="48"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          <circle *ngIf="getTaskTypeColor(item.task)" 
                  [attr.cx]="getItemX(item, 0) + 12" 
                  cy="35" 
                  r="4" 
                  [attr.fill]="getTaskTypeColor(item.task)"
                  stroke="white" 
                  stroke-width="1"
                  class="task-type-indicator" />
          <text [attr.x]="getItemX(item, 0) + (getTaskTypeColor(item.task) ? 18 : 10)" y="45" [attr.font-size]="taskFontSize" 
                [attr.fill]="shouldShowAsHidden(item) ? '#888' : '#111'" 
                alignment-baseline="middle"
                class="task-text">
            {{ getItemText(item, 0) }}
          </text>
        </g>
        <line *ngIf="isNowInSection(0)" [attr.x1]="getNowX(0)" y1="10" [attr.x2]="getNowX(0)" y2="70" stroke="#f87171" stroke-width="2" stroke-dasharray="4 2" />
        <!-- Sombra de previsualización -->
        <rect *ngIf="previewState.visible && previewState.section === 0"
              [attr.x]="previewState.x"
              [attr.y]="previewState.y"
              [attr.width]="previewState.width"
              [attr.height]="previewState.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="6" ry="6"
              class="preview-shadow"
              pointer-events="none" />
        <!-- Sombra de previsualización secundaria -->
        <rect *ngIf="previewStateSecondary.visible && previewStateSecondary.section === 0"
              [attr.x]="previewStateSecondary.x"
              [attr.y]="previewStateSecondary.y"
              [attr.width]="previewStateSecondary.width"
              [attr.height]="previewStateSecondary.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="6" ry="6"
              class="preview-shadow"
              pointer-events="none" />
        <!-- Rectángulo de selección de rango para crear nueva tarea -->
        <rect *ngIf="rangeSelectionRect.visible && rangeSelectionRect.section === 0"
              [attr.x]="rangeSelectionRect.x"
              [attr.y]="rangeSelectionRect.y"
              [attr.width]="rangeSelectionRect.width"
              [attr.height]="rangeSelectionRect.height"
              fill="rgba(16, 185, 129, 0.3)"
              stroke="#10b981"
              stroke-width="2"
              stroke-dasharray="6 3"
              rx="6" ry="6"
              class="range-selection"
              pointer-events="none" />
      </g>

      <!-- Tercio 2: 08:00 - 16:00 -->
      <g [attr.transform]="'translate(0, ' + sectionHeight + ')'">
        <rect x="0" y="0" [attr.width]="svgWidth" [attr.height]="sectionHeight" fill="#e9eff5" rx="6" ry="6"/>
        <line x1="0" y1="40" [attr.x2]="svgWidth" y2="40" stroke="#888" stroke-width="1.5" />
        <text x="10" y="15" [attr.font-size]="titleFontSize" fill="#333" font-weight="bold">08:00 - 16:00</text>
        <g *ngFor="let hour of hoursPerSection[1]">
          <line [attr.x1]="getX(hour, 8)" y1="30" [attr.x2]="getX(hour, 8)" y2="50" stroke="#bbb" stroke-width="1" />
          <text [attr.x]="getX(hour, 8)" y="65" [attr.font-size]="hourFontSize" text-anchor="middle" fill="#666">{{ hour }}:00</text>
        </g>
        <g *ngFor="let item of getRenderableItemsForSection(1); trackBy: trackByRenderableItem"
           [class.task-overdue]="isTaskOverdue(item.task)"
           [class.task-running]="isTaskRunning(item.task)"
           [class.task-hidden]="shouldShowAsHidden(item)"
           [class.task-overlapping]="hasIntersection(item, 1)"
           class="task-group">
          <!-- Borde negro exterior -->
          <rect #taskRect
                [attr.x]="getItemX(item, 8)" y="20" [attr.width]="getItemWidth(item, 8)" height="40"
                [attr.fill]="getTaskColor(item.task)" rx="6" ry="6" 
                [attr.fill-opacity]="getItemOpacity(item, 1)" 
                stroke="rgba(0,0,0,0.6)" stroke-width="1.5" 
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="8"
                class="task-rect" />
          <!-- Borde blanco interior -->
          <rect [attr.x]="getItemX(item, 8)" y="20" [attr.width]="getItemWidth(item, 8)" height="40"
                fill="none" rx="6" ry="6" 
                stroke="rgba(255,255,255,0.8)" stroke-width="1" 
                class="task-inner"
                [attr.data-task-id]="item.task.id" />
          <!-- Handle izquierdo (resize inicio) -->
          <rect #resizeHandleStart
                [attr.x]="getItemX(item, 8)" y="24" width="6" height="32"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-left"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="8" />
          <line [attr.x1]="getItemX(item, 8) + 3" y1="32" [attr.x2]="getItemX(item, 8) + 3" y2="48"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          <!-- Handle derecho (resize fin) -->
          <rect #resizeHandleEnd
                [attr.x]="getItemX(item, 8) + getItemWidth(item, 8) - 6" y="24" width="6" height="32"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-right"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="8" />
          <line [attr.x1]="getItemX(item, 8) + getItemWidth(item, 8) - 3" y1="32" [attr.x2]="getItemX(item, 8) + getItemWidth(item, 8) - 3" y2="48"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          <circle *ngIf="getTaskTypeColor(item.task)" 
                  [attr.cx]="getItemX(item, 8) + 12" 
                  cy="35" 
                  r="4" 
                  [attr.fill]="getTaskTypeColor(item.task)"
                  stroke="white" 
                  stroke-width="1"
                  class="task-type-indicator" />
          <text [attr.x]="getItemX(item, 8) + (getTaskTypeColor(item.task) ? 18 : 10)" y="45" [attr.font-size]="taskFontSize" 
                [attr.fill]="shouldShowAsHidden(item) ? '#888' : '#111'" 
                alignment-baseline="middle"
                class="task-text">
            {{ getItemText(item, 8) }}
          </text>
        </g>
        <line *ngIf="isNowInSection(1)" [attr.x1]="getNowX(8)" y1="10" [attr.x2]="getNowX(8)" y2="70" stroke="#f87171" stroke-width="2" stroke-dasharray="4 2" />
        <!-- Sombra de previsualización -->
        <rect *ngIf="previewState.visible && previewState.section === 8"
              [attr.x]="previewState.x"
              [attr.y]="previewState.y"
              [attr.width]="previewState.width"
              [attr.height]="previewState.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="6" ry="6"
              class="preview-shadow"
              pointer-events="none" />
        <!-- Sombra de previsualización secundaria -->
        <rect *ngIf="previewStateSecondary.visible && previewStateSecondary.section === 8"
              [attr.x]="previewStateSecondary.x"
              [attr.y]="previewStateSecondary.y"
              [attr.width]="previewStateSecondary.width"
              [attr.height]="previewStateSecondary.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="6" ry="6"
              class="preview-shadow"
              pointer-events="none" />
        <!-- Rectángulo de selección de rango para crear nueva tarea -->
        <rect *ngIf="rangeSelectionRect.visible && rangeSelectionRect.section === 8"
              [attr.x]="rangeSelectionRect.x"
              [attr.y]="rangeSelectionRect.y"
              [attr.width]="rangeSelectionRect.width"
              [attr.height]="rangeSelectionRect.height"
              fill="rgba(16, 185, 129, 0.3)"
              stroke="#10b981"
              stroke-width="2"
              stroke-dasharray="6 3"
              rx="6" ry="6"
              class="range-selection"
              pointer-events="none" />
      </g>

      <!-- Tercio 3: 16:00 - 24:00 -->
      <g [attr.transform]="'translate(0, ' + (sectionHeight * 2) + ')'">
        <rect x="0" y="0" [attr.width]="svgWidth" [attr.height]="sectionHeight" fill="#e2eaf0" rx="6" ry="6"/>
        <line x1="0" y1="40" [attr.x2]="svgWidth" y2="40" stroke="#888" stroke-width="1.5" />
        <text x="10" y="15" [attr.font-size]="titleFontSize" fill="#333" font-weight="bold">16:00 - 24:00</text>
        <g *ngFor="let hour of hoursPerSection[2]">
          <line [attr.x1]="getX(hour, 16)" y1="30" [attr.x2]="getX(hour, 16)" y2="50" stroke="#bbb" stroke-width="1" />
          <text [attr.x]="getX(hour, 16)" y="65" [attr.font-size]="hourFontSize" text-anchor="middle" fill="#666">{{ hour }}:00</text>
        </g>
        <g *ngFor="let item of getRenderableItemsForSection(2); trackBy: trackByRenderableItem"
           [class.task-overdue]="isTaskOverdue(item.task)"
           [class.task-running]="isTaskRunning(item.task)"
           [class.task-hidden]="shouldShowAsHidden(item)"
           [class.task-overlapping]="hasIntersection(item, 2)"
           class="task-group">
          <!-- Borde negro exterior -->
          <rect #taskRect
                [attr.x]="getItemX(item, 16)" y="20" [attr.width]="getItemWidth(item, 16)" height="40"
                [attr.fill]="getTaskColor(item.task)" rx="6" ry="6" 
                [attr.fill-opacity]="getItemOpacity(item, 2)" 
                stroke="rgba(0,0,0,0.6)" stroke-width="1.5" 
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="16"
                class="task-rect" />
          <!-- Borde blanco interior -->
          <rect [attr.x]="getItemX(item, 16)" y="20" [attr.width]="getItemWidth(item, 16)" height="40"
                fill="none" rx="6" ry="6" 
                stroke="rgba(255,255,255,0.8)" stroke-width="1" 
                class="task-inner"
                [attr.data-task-id]="item.task.id" />
          <!-- Handle izquierdo (resize inicio) -->
          <rect #resizeHandleStart
                [attr.x]="getItemX(item, 16)" y="24" width="6" height="32"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-left"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="16" />
          <line [attr.x1]="getItemX(item, 16) + 3" y1="32" [attr.x2]="getItemX(item, 16) + 3" y2="48"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          <!-- Handle derecho (resize fin) -->
          <rect #resizeHandleEnd
                [attr.x]="getItemX(item, 16) + getItemWidth(item, 16) - 6" y="24" width="6" height="32"
                fill="rgba(255,255,255,0.3)" rx="2" ry="2"
                class="resize-handle resize-handle-right"
                [attr.data-task-id]="item.task.id"
                [attr.data-fragment-index]="item.fragmentIndex"
                [attr.data-section]="16" />
          <line [attr.x1]="getItemX(item, 16) + getItemWidth(item, 16) - 3" y1="32" [attr.x2]="getItemX(item, 16) + getItemWidth(item, 16) - 3" y2="48"
                stroke="rgba(0,0,0,0.3)" stroke-width="1" stroke-linecap="round"
                class="resize-handle-line" />
          <circle *ngIf="getTaskTypeColor(item.task)" 
                  [attr.cx]="getItemX(item, 16) + 12" 
                  cy="35" 
                  r="4" 
                  [attr.fill]="getTaskTypeColor(item.task)"
                  stroke="white" 
                  stroke-width="1"
                  class="task-type-indicator" />
          <text [attr.x]="getItemX(item, 16) + (getTaskTypeColor(item.task) ? 18 : 10)" y="45" [attr.font-size]="taskFontSize" 
                [attr.fill]="shouldShowAsHidden(item) ? '#888' : '#111'" 
                alignment-baseline="middle"
                class="task-text">
            {{ getItemText(item, 16) }}
          </text>
        </g>
        <line *ngIf="isNowInSection(2)" [attr.x1]="getNowX(16)" y1="10" [attr.x2]="getNowX(16)" y2="70" stroke="#f87171" stroke-width="2" stroke-dasharray="4 2" />
        <!-- Sombra de previsualización -->
        <rect *ngIf="previewState.visible && previewState.section === 16"
              [attr.x]="previewState.x"
              [attr.y]="previewState.y"
              [attr.width]="previewState.width"
              [attr.height]="previewState.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="6" ry="6"
              class="preview-shadow"
              pointer-events="none" />
        <!-- Sombra de previsualización secundaria -->
        <rect *ngIf="previewStateSecondary.visible && previewStateSecondary.section === 16"
              [attr.x]="previewStateSecondary.x"
              [attr.y]="previewStateSecondary.y"
              [attr.width]="previewStateSecondary.width"
              [attr.height]="previewStateSecondary.height"
              fill="rgba(99, 102, 241, 0.2)"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="4 4"
              rx="6" ry="6"
              class="preview-shadow"
              pointer-events="none" />
        <!-- Rectángulo de selección de rango para crear nueva tarea -->
        <rect *ngIf="rangeSelectionRect.visible && rangeSelectionRect.section === 16"
              [attr.x]="rangeSelectionRect.x"
              [attr.y]="rangeSelectionRect.y"
              [attr.width]="rangeSelectionRect.width"
              [attr.height]="rangeSelectionRect.height"
              fill="rgba(16, 185, 129, 0.3)"
              stroke="#10b981"
              stroke-width="2"
              stroke-dasharray="6 3"
              rx="6" ry="6"
              class="range-selection"
              pointer-events="none" />
      </g>
    </svg>
  </div>

  <!-- Menú contextual -->
  <div *ngIf="showContextMenu && contextMenuTask" 
       class="context-menu"
       [style.left.px]="contextMenuX"
       [style.top.px]="contextMenuY"
       (click)="$event.stopPropagation()">
    <div class="context-menu-header">
      <span class="text-lg mr-2">{{ contextMenuTask.emoji }}</span>
      <span class="font-semibold text-sm truncate">{{ contextMenuTask.name }}</span>
    </div>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item" (click)="copyTitle()">
      <i class="fas fa-copy mr-2"></i>
      Copy Title
    </button>
    <button *ngIf="hasComplexGroup()" class="context-menu-item" (click)="copyComplexTitle()">
      <i class="fas fa-clipboard mr-2"></i>
      Copy Complex Title
    </button>
    <button *ngIf="hasComplexGroup()" class="context-menu-item" (click)="copyComplexTitleWithTitle()">
      <i class="fas fa-clipboard mr-2"></i>
      Copy Complex Title + Title
    </button>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item context-menu-item-edit" (click)="editTaskFromContextMenu()">
      <i class="fas fa-edit mr-2"></i>
      Editar tarea
    </button>
    <div class="context-menu-divider"></div>
    <button *ngIf="contextMenuTask.hidden" class="context-menu-item" (click)="toggleHiddenFromContextMenu()">
      <i class="fas fa-eye mr-2"></i>
      Mostrar
    </button>
    <button *ngIf="!contextMenuTask.hidden" class="context-menu-item" (click)="toggleHiddenFromContextMenu()">
      <i class="fas fa-eye-slash mr-2"></i>
      Ocultar
    </button>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item-with-submenu" 
         (mouseenter)="onActionsMouseEnter($event)" 
         (mouseleave)="onActionsMouseLeave()">
      <button class="context-menu-item">
        <i class="fas fa-clock mr-2"></i>
        Acciones
        <i class="fas fa-chevron-right ml-auto"></i>
      </button>
    </div>
    <div *ngIf="isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)" class="context-menu-divider"></div>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'completed'" 
            class="context-menu-item context-menu-item-completed" 
            (click)="changeStatusFromContextMenu('completed')">
      <i class="fas fa-check mr-2"></i>
      Marcar completada
    </button>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'in-progress'" 
            class="context-menu-item context-menu-item-progress" 
            (click)="changeStatusFromContextMenu('in-progress')">
      <i class="fas fa-spinner mr-2"></i>
      Marcar en progreso
    </button>
    <button *ngIf="(isTaskOverdue(contextMenuTask) || isTaskRunning(contextMenuTask)) && contextMenuTask.status !== 'pending'" 
            class="context-menu-item context-menu-item-pending" 
            (click)="changeStatusFromContextMenu('pending')">
      <i class="fas fa-play mr-2"></i>
      Marcar pendiente
    </button>
    <div class="context-menu-divider"></div>
    <button class="context-menu-item delete" (click)="deleteTaskFromContextMenu()">
      <i class="fas fa-trash-alt mr-2"></i>
      Eliminar tarea
    </button>
  </div>

  <!-- Menú de selección de tareas superpuestas -->
  <div *ngIf="showTaskSelector && taskSelectorItems.length > 1" 
       class="task-selector-menu"
       [style.left.px]="taskSelectorX"
       [style.top.px]="taskSelectorY"
       (click)="$event.stopPropagation()">
    <div class="task-selector-header">
      <i class="fas fa-layer-group mr-2"></i>
      <span class="font-semibold text-sm">Tareas superpuestas ({{ taskSelectorItems.length }})</span>
    </div>
    <div class="task-selector-subtitle">
      Selecciona la tarea que deseas traer al frente
    </div>
    <div class="task-selector-divider"></div>
    <div class="task-selector-list">
      <button *ngFor="let item of taskSelectorItems; let i = index" 
              class="task-selector-item"
              [style.border-left-color]="getTaskColor(item.task)"
              (click)="selectTaskFromSelector(item)">
        <div class="task-selector-item-content">
          <div class="task-selector-item-name">{{ getItemShortText(item) }}</div>
          <div class="task-selector-item-time">{{ getItemTimeRange(item) }}</div>
        </div>
        <i class="fas fa-arrow-up task-selector-item-icon" title="Traer al frente"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal de desplazamiento de tiempo -->
<app-time-shift-modal 
  *ngIf="showTimeShiftModal && timeShiftTask"
  [task]="timeShiftTask"
  [taskGroups]="taskGroups"
  [fragmentIndex]="timeShiftFragmentIndex"
  [isVertical]="false"
  [suggestedDirection]="suggestedShiftDirection"
  [suggestedMinutes]="suggestedShiftMinutes"
  (confirm)="onTimeShiftConfirm($event)"
  (cancel)="onTimeShiftCancel()">
</app-time-shift-modal>

<!-- Modal de edición de duración -->
<app-duration-edit-modal
  *ngIf="showDurationModal && durationTask"
  [task]="durationTask"
  [taskGroups]="taskGroups"
  [fragmentIndex]="durationFragmentIndex"
  [suggestedAdjustStart]="suggestedAdjustStart"
  [suggestedDurationMinutes]="suggestedDurationMinutes"
  (confirm)="onDurationConfirm($event)"
  (cancel)="onDurationCancel()">
</app-duration-edit-modal>

