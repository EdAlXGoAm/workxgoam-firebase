<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
    <!-- Header del Modal -->
    <div class="p-6 border-b border-gray-200 flex-shrink-0">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">
          Tareas del Proyecto: {{ project?.name }}
        </h3>
        <button (click)="onClose()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <!-- Suma de duraciones y botón guardar -->
      <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
          <span class="text-lg font-semibold text-indigo-800">
            <i class="fas fa-clock mr-2"></i>Duración Total:
          </span>
          <span class="text-2xl font-bold text-indigo-600">
            {{ getTotalProjectDuration() }}
          </span>
        </div>
        <div class="flex justify-end">
          <button 
            (click)="openSaveSumTemplateModal()" 
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center gap-2">
            <i class="fas fa-save"></i>
            <span>{{ editingTemplateId ? 'Actualizar Suma' : 'Guardar Suma' }}</span>
          </button>
        </div>
      </div>
      
      <!-- Filtros de Fecha -->
      <div class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-semibold text-gray-700 flex items-center">
            <i class="fas fa-filter mr-2 text-indigo-600"></i>
            Filtrar por Fecha de Inicio
          </h4>
          <button 
            *ngIf="pendingStartDateFilter || pendingEndDateFilter"
            (click)="clearDateFilters()" 
            class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
            Limpiar filtros
          </button>
        </div>
        <!-- Botones de acceso rápido -->
        <div class="flex flex-wrap gap-2 mb-3">
          <button 
            (click)="setQuickFilter('today')"
            [disabled]="isFilteringTasks"
            [class.bg-indigo-600]="isQuickFilterActive('today')"
            [class.text-white]="isQuickFilterActive('today')"
            [class.bg-gray-100]="!isQuickFilterActive('today')"
            [class.text-gray-700]="!isQuickFilterActive('today')"
            class="px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-indigo-500 hover:text-white transition-colors disabled:opacity-50">
            Hoy
          </button>
          <button 
            (click)="setQuickFilter('yesterday')"
            [disabled]="isFilteringTasks"
            [class.bg-indigo-600]="isQuickFilterActive('yesterday')"
            [class.text-white]="isQuickFilterActive('yesterday')"
            [class.bg-gray-100]="!isQuickFilterActive('yesterday')"
            [class.text-gray-700]="!isQuickFilterActive('yesterday')"
            class="px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-indigo-500 hover:text-white transition-colors disabled:opacity-50">
            Ayer
          </button>
          <button 
            (click)="setQuickFilter('week')"
            [disabled]="isFilteringTasks"
            [class.bg-indigo-600]="isQuickFilterActive('week')"
            [class.text-white]="isQuickFilterActive('week')"
            [class.bg-gray-100]="!isQuickFilterActive('week')"
            [class.text-gray-700]="!isQuickFilterActive('week')"
            class="px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-indigo-500 hover:text-white transition-colors disabled:opacity-50">
            Esta Semana
          </button>
          <button 
            (click)="setQuickFilter('month')"
            [disabled]="isFilteringTasks"
            [class.bg-indigo-600]="isQuickFilterActive('month')"
            [class.text-white]="isQuickFilterActive('month')"
            [class.bg-gray-100]="!isQuickFilterActive('month')"
            [class.text-gray-700]="!isQuickFilterActive('month')"
            class="px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-indigo-500 hover:text-white transition-colors disabled:opacity-50">
            Este Mes
          </button>
          <button 
            (click)="setQuickFilter('all')"
            [disabled]="isFilteringTasks"
            [class.bg-indigo-600]="isQuickFilterActive('all')"
            [class.text-white]="isQuickFilterActive('all')"
            [class.bg-gray-100]="!isQuickFilterActive('all')"
            [class.text-gray-700]="!isQuickFilterActive('all')"
            class="px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-indigo-500 hover:text-white transition-colors disabled:opacity-50">
            Todo
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              <i class="fas fa-play-circle mr-1 text-blue-600"></i>Fecha Inicio
            </label>
            <app-android-date-picker
              [(ngModel)]="pendingStartDateFilter"
              (ngModelChange)="onDateFilterChange()"
              name="startDateFilter"
              label="Fecha de inicio"
              placeholder="Seleccionar fecha de inicio"
              [disabled]="isFilteringTasks">
            </app-android-date-picker>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              <i class="fas fa-stop-circle mr-1 text-green-600"></i>Fecha Fin
            </label>
            <app-android-date-picker
              [(ngModel)]="pendingEndDateFilter"
              (ngModelChange)="onDateFilterChange()"
              name="endDateFilter"
              label="Fecha de fin"
              placeholder="Seleccionar fecha de fin"
              [disabled]="isFilteringTasks">
            </app-android-date-picker>
          </div>
        </div>
        
        <!-- Botón Aplicar Filtro -->
        <div class="mt-3 flex items-center gap-3">
          <button 
            *ngIf="hasFilterChanges"
            (click)="applyDateFilters()"
            [disabled]="isFilteringTasks"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors disabled:bg-indigo-400 disabled:cursor-not-allowed flex items-center gap-2">
            <i *ngIf="isFilteringTasks" class="fas fa-spinner fa-spin"></i>
            <i *ngIf="!isFilteringTasks" class="fas fa-check"></i>
            {{ isFilteringTasks ? 'Aplicando...' : 'Aplicar filtro' }}
          </button>
          <span *ngIf="hasFilterChanges && !isFilteringTasks" class="text-xs text-amber-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            Hay cambios sin aplicar
          </span>
        </div>
        
        <div *ngIf="startDateFilter || endDateFilter" class="mt-2 text-xs text-gray-600">
          <i class="fas fa-info-circle mr-1"></i>
          <span *ngIf="isQuickFilterActive('today')">Mostrando solo las tareas de hoy</span>
          <span *ngIf="isQuickFilterActive('yesterday')">Mostrando solo las tareas de ayer</span>
          <span *ngIf="isQuickFilterActive('week')">Mostrando las tareas de esta semana (desde el lunes)</span>
          <span *ngIf="isQuickFilterActive('month')">Mostrando las tareas de este mes</span>
          <span *ngIf="!isQuickFilterActive('today') && !isQuickFilterActive('yesterday') && !isQuickFilterActive('week') && !isQuickFilterActive('month')">
            Mostrando tareas con fecha de inicio 
            <span *ngIf="startDateFilter">desde {{ startDateFilter }}</span>
            <span *ngIf="startDateFilter && endDateFilter"> hasta </span>
            <span *ngIf="endDateFilter">{{ endDateFilter }}</span>
          </span>
        </div>
        <div *ngIf="!startDateFilter && !endDateFilter" class="mt-2 text-xs text-amber-600">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          Mostrando todas las tareas (puede tardar en cargar)
        </div>
      </div>
    </div>
    
    <!-- Contenedor Principal Scrollable -->
    <div class="flex-1 overflow-y-auto relative">
      <!-- Overlay de carga mientras se filtra -->
      <div *ngIf="isFilteringTasks" class="absolute inset-0 bg-white bg-opacity-80 z-20 flex items-center justify-center">
        <div class="flex flex-col items-center gap-3">
          <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
          <span class="text-gray-600 font-medium">Aplicando filtros...</span>
        </div>
      </div>
      
      <!-- Vista SVG Semanal -->
      <div class="border-b border-gray-200 pb-4 mb-4">
        <div class="px-6 pt-4">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fas fa-calendar-week mr-2 text-indigo-600"></i>
              Vista Semanal (Tareas Seleccionadas)
            </h4>
            <button 
              (click)="toggleCalendarExpanded()" 
              class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors flex items-center gap-2">
              <i class="fas" [ngClass]="isCalendarExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              <span>{{ isCalendarExpanded ? 'Comprimir' : 'Expandir' }}</span>
            </button>
          </div>
          <div *ngIf="isCalendarExpanded" class="bg-gray-50 rounded-lg p-3 border border-gray-200 overflow-x-auto">
            <app-week-timeline-svg 
              [tasks]="getSelectedProjectTasks()" 
              [environments]="environments" 
              [taskTypes]="taskTypes" 
              [projects]="projects"
              [taskGroups]="taskGroups"
              (editTask)="onEditTask($event)"
              (deleteTask)="onDeleteTask($event)"
              (toggleHidden)="onToggleHidden($event)"
              (changeStatus)="onChangeStatus($event)"
              (taskUpdated)="onTaskUpdated($event)">
            </app-week-timeline-svg>
          </div>
        </div>
      </div>
      
      <!-- Lista de Tareas -->
      <div class="p-6">
      <div *ngIf="projectTasksForModal.length === 0" class="text-center text-gray-500 py-8">
        <i class="fas fa-inbox text-4xl mb-4"></i>
        <p>No hay tareas en este proyecto</p>
      </div>
      <div *ngIf="projectTasksForModal.length > 0">
        <ng-container *ngFor="let dateKey of getGroupedProjectTasksKeys(); let dateIndex = index">
          <ng-container *ngIf="getGroupedProjectTasksByGroup()[dateKey]">
            <!-- Encabezado de fecha -->
            <div class="sticky top-0 bg-gray-50 border-b-2 border-indigo-200 py-3 px-4 mb-4 -mx-6 z-10">
              <div class="flex items-center justify-between">
                <h4 class="text-lg font-bold text-gray-800 flex items-center">
                  <i class="fas fa-calendar-day mr-2 text-indigo-600"></i>
                  <span *ngIf="dateKey !== 'sin-fecha' && getFirstTaskDateForDay(dateKey)">
                    {{ formatTaskDate(getFirstTaskDateForDay(dateKey)) }}
                  </span>
                  <span *ngIf="dateKey === 'sin-fecha'">Sin fecha</span>
                </h4>
                <div class="flex items-center text-sm font-semibold text-indigo-600">
                  <i class="fas fa-clock mr-2"></i>
                  <span>{{ getDayTotalDuration(dateKey) }}</span>
                </div>
              </div>
            </div>
            
            <!-- Tarjetas del día -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <!-- Grupos de tareas (solo se muestran en la fecha más reciente) -->
              <ng-container *ngFor="let groupId of getGroupKeysForDate(dateKey)">
                <div class="bg-white border-2 border-indigo-300 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                  <!-- Header del grupo -->
                  <div class="bg-indigo-50 border-b border-indigo-200 px-4 py-3 rounded-t-lg">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <input type="checkbox" 
                               [checked]="isGroupSelected(groupId)"
                               [attr.data-group-id]="groupId"
                               (click)="toggleGroupSelection(groupId); $event.preventDefault()"
                               class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer flex-shrink-0">
                        <div class="flex-1 min-w-0">
                          <h5 class="text-base font-semibold text-indigo-800 truncate">
                            {{ getTaskGroupName(groupId) }}
                          </h5>
                          <p class="text-xs text-indigo-600 mt-1">
                            {{ getGroupTasksForDate(dateKey, groupId).length }} {{ getGroupTasksForDate(dateKey, groupId).length === 1 ? 'tarea' : 'tareas' }}
                            <span *ngIf="getGroupUniqueDates(groupId) > 1" class="text-indigo-400 ml-1">
                              ({{ getGroupUniqueDates(groupId) }} días)
                            </span>
                          </p>
                        </div>
                      </div>
                      <div class="flex items-center text-sm font-semibold text-indigo-600 ml-2">
                        <i class="fas fa-hourglass-half mr-1"></i>
                        <span>{{ getGroupTotalDuration(groupId) }}</span>
                      </div>
                    </div>
                  </div>
                  <!-- Tareas del grupo -->
                  <div class="p-2 space-y-2">
                    <div *ngFor="let task of getGroupTasksForDate(dateKey, groupId)" 
                         class="bg-gray-50 border border-gray-200 rounded p-3">
                      <div class="flex items-start space-x-2">
                        <span class="text-xl flex-shrink-0">{{ task.emoji }}</span>
                        <div class="flex-1 min-w-0">
                          <h6 class="text-sm font-medium text-gray-800 truncate">{{ task.name }}</h6>
                          <div class="flex items-center flex-wrap gap-x-3 gap-y-1 mt-1">
                            <span *ngIf="task.start" class="text-xs text-gray-500">
                              <i class="fas fa-calendar-alt mr-1"></i>{{ formatTaskDate(task.start) }} {{ formatTaskTime(task.start) }}
                            </span>
                            <span *ngIf="getTaskDuration(task) !== null" class="text-xs text-indigo-600">
                              <i class="fas fa-hourglass-half mr-1"></i>{{ formatTaskDuration(getTaskDuration(task)) }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
              
              <!-- Tareas individuales (sin grupo) -->
              <div *ngFor="let task of getIndividualTasksForDate(dateKey); let taskIndex = index" 
                   class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-start space-x-3">
                <!-- Checkbox -->
                <div class="flex-shrink-0 pt-1">
                  <input type="checkbox" 
                         [checked]="projectTaskIncluded[task.id]"
                         (click)="handleCheckboxChange(task, getTaskGlobalIndex(task), $event)"
                         class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                </div>
                
                <!-- Contenido de la tarjeta -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                      <span class="text-2xl">{{ task.emoji }}</span>
                      <h4 class="text-lg font-semibold text-gray-800 truncate">{{ task.name }}</h4>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full flex-shrink-0"
                          [class.bg-green-100]="task.priority === 'low'" [class.text-green-800]="task.priority === 'low'"
                          [class.bg-blue-100]="task.priority === 'medium'" [class.text-blue-800]="task.priority === 'medium'"
                          [class.bg-red-100]="task.priority === 'high'" [class.text-red-800]="task.priority === 'high'"
                          [class.bg-pink-100]="task.priority === 'critical'" [class.text-pink-800]="task.priority === 'critical'">
                      {{ task.priority }}
                    </span>
                  </div>
                  
                  <!-- Fecha y hora de inicio -->
                  <div *ngIf="task.start" class="mb-2 flex items-center text-sm text-gray-600">
                    <i class="fas fa-clock mr-2 text-indigo-500"></i>
                    <span class="font-medium">{{ formatTaskDate(task.start) }} a las {{ formatTaskTime(task.start) }}</span>
                  </div>
                  <div *ngIf="!task.start" class="mb-2 flex items-center text-sm text-gray-400">
                    <i class="fas fa-clock mr-2"></i>
                    <span class="font-medium">Sin fecha de inicio</span>
                  </div>
                  
                  <p *ngIf="task.description" class="text-sm text-gray-600 mb-3 task-description-clamp">{{ task.description }}</p>
                  
                  <div class="flex items-center justify-between text-sm text-gray-500">
                    <div class="flex items-center space-x-4">
                      <span *ngIf="getTaskDuration(task) !== null" class="flex items-center">
                        <i class="fas fa-hourglass-half mr-1"></i>
                        <span class="font-semibold text-indigo-600">{{ formatTaskDuration(getTaskDuration(task)) }}</span>
                      </span>
                      <span *ngIf="getTaskDuration(task) === null" class="text-gray-400">
                        Sin duración
                      </span>
                    </div>
                    <div class="flex items-center space-x-2">
                      <span [class]="'px-2 py-1 text-xs font-semibold rounded-full'"
                            [class.bg-yellow-100]="task.status === 'pending'" [class.text-yellow-800]="task.status === 'pending'"
                            [class.bg-blue-100]="task.status === 'in-progress'" [class.text-blue-800]="task.status === 'in-progress'"
                            [class.bg-green-100]="task.status === 'completed'" [class.text-green-800]="task.status === 'completed'">
                        {{ task.status === 'pending' ? 'Pendiente' : task.status === 'in-progress' ? 'En Progreso' : 'Completada' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </ng-container>
        </ng-container>
      </div>
      </div>
    </div>
    
    <!-- Footer del Modal -->
    <div class="p-6 border-t border-gray-200 flex-shrink-0">
      <div class="flex justify-end">
        <button (click)="onClose()" 
                class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para guardar suma -->
<div *ngIf="showSaveSumTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4" style="overflow: hidden;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md" (click)="$event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">{{ editingTemplateId ? 'Actualizar Suma' : 'Guardar Suma' }}</h3>
        <button (click)="closeSaveSumTemplateModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form (ngSubmit)="saveSum()" class="space-y-4">
        <div>
          <label for="sumTemplateName" class="block text-sm font-medium text-gray-700 mb-2">
            Nombre de la suma
          </label>
          <input 
            type="text" 
            id="sumTemplateName"
            [(ngModel)]="newSumTemplateName" 
            name="sumTemplateName"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="Ej: Sprint 1, Enero 2025, etc."
            required
            autofocus>
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button 
            type="button" 
            (click)="closeSaveSumTemplateModal()"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
            Cancelar
          </button>
          <button 
            type="submit"
            class="px-4 py-2 bg-indigo-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            {{ editingTemplateId ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
